"use strict";import DataConnector from"./DataConnector.js";import GoogleSheetsConverter from"../Converters/GoogleSheetsConverter.js";import U from"../../Core/Utilities.js";const{merge,pick}=U;function isGoogleError(e){return"object"==typeof e&&e&&"object"==typeof e.error&&e.error&&"number"==typeof e.error.code&&"string"==typeof e.error.message&&"string"==typeof e.error.status}class GoogleSheetsConnector extends DataConnector{constructor(e){e=merge(GoogleSheetsConnector.defaultOptions,e);super(e),this.converter=new GoogleSheetsConverter(e),this.options=e}load(o){const t=this,{dataRefreshRate:r,enablePolling:n,firstRowAsNames:s,googleAPIKey:e,googleSpreadsheetKey:a}=t.options,l=GoogleSheetsConnector.buildFetchURL(e,a,t.options);return t.table.deleteColumns(),t.emit({type:"load",detail:o,table:t.table,url:l}),fetch(l).then(e=>e.json().then(e=>{if(isGoogleError(e))throw new Error(e.error.message);t.converter.parse({firstRowAsNames:s,json:e}),t.table.setColumns(t.converter.getTable().getColumns()),t.emit({type:"afterLoad",detail:o,table:t.table,url:l}),n&&setTimeout(()=>t.load(),1e3*Math.max(r||0,1))})).catch(e=>(t.emit({type:"loadError",detail:o,error:e,table:t.table}),Promise.reject(e))).then(()=>t)}}GoogleSheetsConnector.defaultOptions={googleAPIKey:"",googleSpreadsheetKey:"",worksheet:1,enablePolling:!1,dataRefreshRate:2,firstRowAsNames:!0},function(e){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function r(e={}){var{endColumn:e,endRow:o,googleSpreadsheetRange:t,startColumn:r,startRow:n}=e;return t||(s[r||0]||"A")+(Math.max(n||0,0)+1)+":"+(s[pick(e,25)]||"Z")+(o?Math.max(o,0):"Z")}e.buildFetchURL=function(e,o,t={}){return`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/`+(t.onlyColumnNames?"A1:Z1":r(t))+"?alt=json"+(t.onlyColumnNames?"":"&dateTimeRenderOption=FORMATTED_STRING&majorDimension=COLUMNS&valueRenderOption=UNFORMATTED_VALUE")+"&prettyPrint=false&key="+e},e.buildQueryRange=r}(GoogleSheetsConnector=GoogleSheetsConnector||{}),DataConnector.registerType("GoogleSheets",GoogleSheetsConnector);export default GoogleSheetsConnector;