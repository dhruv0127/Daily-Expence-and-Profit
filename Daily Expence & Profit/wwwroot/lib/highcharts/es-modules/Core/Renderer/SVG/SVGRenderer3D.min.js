"use strict";import A from"../../Animation/AnimationUtilities.js";const animObject=A["animObject"];import Color from"../../Color/Color.js";const color=Color["parse"];import H from"../../Globals.js";const{charts,deg2rad}=H;import Math3D from"../../Math3D.js";const{perspective,shapeArea}=Math3D;import SVGElement from"./SVGElement.js";import SVGElement3D from"./SVGElement3D.js";import SVGRenderer from"./SVGRenderer.js";import U from"../../Utilities.js";const{defined,extend,merge,pick}=U,cos=Math.cos,sin=Math.sin,PI=Math.PI,dFactor=4*(Math.sqrt(2)-1)/3/(PI/2);class SVGRenderer3D extends SVGRenderer{static compose(e){const t=e.prototype,n=SVGRenderer3D.prototype;t.elements3d=SVGElement3D,t.arc3d=n.arc3d,t.arc3dPath=n.arc3dPath,t.cuboid=n.cuboid,t.cuboidPath=n.cuboidPath,t.element3d=n.element3d,t.face3d=n.face3d,t.polyhedron=n.polyhedron,t.toLinePath=n.toLinePath,t.toLineSegments=n.toLineSegments}static curveTo(e,t,n,s,a,r,i,o){let h=[],d=r-a;return a<r&&r-a>Math.PI/2+1e-4?h=(h=h.concat(this.curveTo(e,t,n,s,a,a+Math.PI/2,i,o))).concat(this.curveTo(e,t,n,s,a+Math.PI/2,r,i,o)):r<a&&a-r>Math.PI/2+1e-4?h=(h=h.concat(this.curveTo(e,t,n,s,a,a-Math.PI/2,i,o))).concat(this.curveTo(e,t,n,s,a-Math.PI/2,r,i,o)):[["C",e+n*Math.cos(a)-n*dFactor*d*Math.sin(a)+i,t+s*Math.sin(a)+s*dFactor*d*Math.cos(a)+o,e+n*Math.cos(r)+n*dFactor*d*Math.sin(r)+i,t+s*Math.sin(r)-s*dFactor*d*Math.cos(r)+o,e+n*Math.cos(r)+i,t+s*Math.sin(r)+o]]}toLinePath(e,t){const n=[];return e.forEach(function(e){n.push(["L",e.x,e.y])}),e.length&&(n[0][0]="M",t&&n.push(["Z"])),n}toLineSegments(e){let t=[],n=!0;return e.forEach(function(e){t.push(n?["M",e.x,e.y]:["L",e.x,e.y]),n=!n}),t}face3d(e){const s=this,t=this.createElement("path");return t.vertexes=[],t.insidePlotArea=!1,t.enabled=!0,t.attr=function(e){var t,n;return"object"==typeof e&&(defined(e.enabled)||defined(e.vertexes)||defined(e.insidePlotArea))&&(this.enabled=pick(e.enabled,this.enabled),this.vertexes=pick(e.vertexes,this.vertexes),this.insidePlotArea=pick(e.insidePlotArea,this.insidePlotArea),delete e.enabled,delete e.vertexes,delete e.insidePlotArea,n=charts[s.chartIndex],n=perspective(this.vertexes,n,this.insidePlotArea),t=s.toLinePath(n,!0),n=shapeArea(n),e.d=t,e.visibility=this.enabled&&0<n?"inherit":"hidden"),SVGElement.prototype.attr.apply(this,arguments)},t.animate=function(e){var t,n;return"object"==typeof e&&(defined(e.enabled)||defined(e.vertexes)||defined(e.insidePlotArea))&&(this.enabled=pick(e.enabled,this.enabled),this.vertexes=pick(e.vertexes,this.vertexes),this.insidePlotArea=pick(e.insidePlotArea,this.insidePlotArea),delete e.enabled,delete e.vertexes,delete e.insidePlotArea,n=charts[s.chartIndex],n=perspective(this.vertexes,n,this.insidePlotArea),t=s.toLinePath(n,!0),n=shapeArea(n),n=this.enabled&&0<n?"visible":"hidden",e.d=t,this.attr("visibility",n)),SVGElement.prototype.animate.apply(this,arguments)},t.attr(e)}polyhedron(e){const a=this,r=this.g(),t=r.destroy;return this.styledMode||r.attr({"stroke-linejoin":"round"}),r.faces=[],r.destroy=function(){for(let e=0;e<r.faces.length;e++)r.faces[e].destroy();return t.call(this)},r.attr=function(t,e,n,s){if("object"==typeof t&&defined(t.faces)){for(;r.faces.length>t.faces.length;)r.faces.pop().destroy();for(;r.faces.length<t.faces.length;)r.faces.push(a.face3d().add(r));for(let e=0;e<t.faces.length;e++)a.styledMode&&delete t.faces[e].fill,r.faces[e].attr(t.faces[e],null,n,s);delete t.faces}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(t,n,s){if(t&&t.faces){for(;r.faces.length>t.faces.length;)r.faces.pop().destroy();for(;r.faces.length<t.faces.length;)r.faces.push(a.face3d().add(r));for(let e=0;e<t.faces.length;e++)r.faces[e].animate(t.faces[e],n,s);delete t.faces}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(e)}element3d(e,t){const n=this.g();return extend(n,this.elements3d[e]),n.initArgs(t),n}cuboid(e){return this.element3d("cuboid",e)}cuboidPath(e){let t=e.x||0,n=e.y||0,s=e.z||0,a=e.height||0,r=e.width||0,i=e.depth||0,o=charts[this.chartIndex],h,d,c,l,p,u,f,m=o.options.chart.options3d,M=m.alpha,y=0,x=[{x:t,y:n,z:s},{x:t+r,y:n,z:s},{x:t+r,y:n+a,z:s},{x:t,y:n+a,z:s},{x:t,y:n+a,z:s+i},{x:t+r,y:n+a,z:s+i},{x:t+r,y:n,z:s+i},{x:t,y:n,z:s+i}],P=[],b;function v(e){return 0===a&&1<e&&e<6?{x:x[e].x,y:x[e].y+10,z:x[e].z}:x[0].x===x[7].x&&4<=e?{x:x[e].x+10,y:x[e].y,z:x[e].z}:0===i&&e<2||5<e?{x:x[e].x,y:x[e].y,z:x[e].z+10}:x[e]}function S(e){return x[e]}return x=perspective(x,o,e.insidePlotArea),d=(h=(b=function(e,t,n){let s=[[],-1],a=e.map(S),r=t.map(S),i=e.map(v),o=t.map(v);return shapeArea(a)<0?s=[a,0]:shapeArea(r)<0?s=[r,1]:n&&(P.push(n),s=!(shapeArea(i)<0)&&shapeArea(o)<0?[r,1]:[a,0]),s})([3,2,1,0],[7,6,5,4],"front"))[0],p=h[1],c=(h=b([1,6,7,0],[4,5,2,3],"top"))[0],u=h[1],l=(h=b([1,2,5,6],[0,7,4,3],"side"))[0],1===(f=h[1])?y+=1e6*(o.plotWidth-t):f||(y+=1e6*t),y+=10*(!u||0<=M&&M<=180||M<360&&357.5<M?o.plotHeight-n:10+n),1===p?y+=100*s:p||(y+=100*(1e3-s)),{front:this.toLinePath(d,!0),top:this.toLinePath(c,!0),side:this.toLinePath(l,!0),zIndexes:{group:Math.round(y)},forcedSides:P,isFront:p,isTop:u}}arc3d(e){const h=this.g(),t=h.renderer,a=["x","y","r","innerR","start","end","depth"];function d(e){let t=!1,n={},s;for(s in e=merge(e))-1!==a.indexOf(s)&&(n[s]=e[s],delete e[s],t=!0);return!!t&&[n,e]}return(e=merge(e)).alpha=(e.alpha||0)*deg2rad,e.beta=(e.beta||0)*deg2rad,h.top=t.path(),h.side1=t.path(),h.side2=t.path(),h.inn=t.path(),h.out=t.path(),h.onAdd=function(){const t=h.parentGroup,n=h.attr("class");h.top.add(h),["out","inn","side1","side2"].forEach(function(e){h[e].attr({class:n+" highcharts-3d-side"}).add(t)})},["addClass","removeClass"].forEach(function(n){h[n]=function(){const t=arguments;["top","out","inn","side1","side2"].forEach(function(e){h[e][n].apply(h[e],t)})}}),h.setPaths=function(e){var t=h.renderer.arc3dPath(e),n=100*t.zTop;h.attribs=e,h.top.attr({d:t.top,zIndex:t.zTop}),h.inn.attr({d:t.inn,zIndex:t.zInn}),h.out.attr({d:t.out,zIndex:t.zOut}),h.side1.attr({d:t.side1,zIndex:t.zSide1}),h.side2.attr({d:t.side2,zIndex:t.zSide2}),h.zIndex=n,h.attr({zIndex:n}),e.center&&(h.top.setRadialReference(e.center),delete e.center)},h.setPaths(e),h.fillSetter=function(e){var t=color(e).brighten(-.1).get();return this.fill=e,this.side1.attr({fill:t}),this.side2.attr({fill:t}),this.inn.attr({fill:t}),this.out.attr({fill:t}),this.top.attr({fill:e}),this},["opacity","translateX","translateY","visibility"].forEach(function(e){h[e+"Setter"]=function(t,n){h[n]=t,["out","inn","side1","side2","top"].forEach(function(e){h[e].attr(n,t)})}}),h.attr=function(e){var t;return"object"==typeof e&&(e=d(e))&&(t=e[0],arguments[0]=e[1],extend(h.attribs,t),h.setPaths(h.attribs)),SVGElement.prototype.attr.apply(h,arguments)},h.animate=function(e,t,n){let s,a=this.attribs,r,i,o="data-"+Math.random().toString(26).substring(2,9);return delete e.center,delete e.z,delete e.alpha,delete e.beta,(i=animObject(pick(t,this.renderer.globalAnimation))).duration&&(s=d(e),h[o]=0,e[o]=1,h[o+"Setter"]=H.noop,s&&(r=s[0],i.step=function(e,t){function n(e){return a[e]+(pick(r[e],a[e])-a[e])*t.pos}t.prop===o&&t.elem.setPaths(merge(a,{x:n("x"),y:n("y"),r:n("r"),innerR:n("innerR"),start:n("start"),end:n("end"),depth:n("depth")}))}),t=i),SVGElement.prototype.animate.call(this,e,t,n)},h.destroy=function(){return this.top.destroy(),this.out.destroy(),this.inn.destroy(),this.side1.destroy(),this.side2.destroy(),SVGElement.prototype.destroy.call(this)},h.hide=function(){this.top.hide(),this.out.hide(),this.inn.hide(),this.side1.hide(),this.side2.hide()},h.show=function(e){this.top.show(e),this.out.show(e),this.inn.show(e),this.side1.show(e),this.side2.show(e)},h}arc3dPath(e){var t=e.x||0,n=e.y||0,s=e.start||0,a=(e.end||0)-1e-5,r=e.r||0,i=e.innerR||0,o=e.depth||0,h=e.alpha||0,e=e.beta||0,d=Math.cos(s),c=Math.sin(s),l=Math.cos(a),p=Math.sin(a),u=r*Math.cos(e),r=r*Math.cos(h),f=i*Math.cos(e),i=i*Math.cos(h),m=o*Math.sin(e),o=o*Math.sin(h);let M=[["M",t+u*d,n+r*c]];(M=M.concat(SVGRenderer3D.curveTo(t,n,u,r,s,a,0,0))).push(["L",t+f*l,n+i*p]),(M=M.concat(SVGRenderer3D.curveTo(t,n,f,i,a,s,0,0))).push(["Z"]);var e=0<e?Math.PI/2:0,h=0<h?0:Math.PI/2,e=!(-e<s)&&-e<a?-e:s,y=!(a<PI-h)&&s<PI-h?PI-h:a,x=2*PI-h;let P=[["M",t+u*cos(e),n+r*sin(e)]],b=(P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,e,y,0,0)),x<a&&s<x?(P.push(["L",t+u*cos(y)+m,n+r*sin(y)+o]),(P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,y,x,m,o))).push(["L",t+u*cos(x),n+r*sin(x)]),(P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,x,a,0,0))).push(["L",t+u*cos(a)+m,n+r*sin(a)+o]),(P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,a,x,m,o))).push(["L",t+u*cos(x),n+r*sin(x)]),P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,x,y,0,0))):a>PI-h&&s<PI-h&&(P.push(["L",t+u*Math.cos(y)+m,n+r*Math.sin(y)+o]),(P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,y,a,m,o))).push(["L",t+u*Math.cos(a),n+r*Math.sin(a)]),P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,a,y,0,0))),P.push(["L",t+u*Math.cos(y)+m,n+r*Math.sin(y)+o]),(P=P.concat(SVGRenderer3D.curveTo(t,n,u,r,y,e,m,o))).push(["Z"]),[["M",t+f*d,n+i*c]]);(b=b.concat(SVGRenderer3D.curveTo(t,n,f,i,s,a,0,0))).push(["L",t+f*Math.cos(a)+m,n+i*Math.sin(a)+o]),(b=b.concat(SVGRenderer3D.curveTo(t,n,f,i,a,s,m,o))).push(["Z"]);x=[["M",t+u*d,n+r*c],["L",t+u*d+m,n+r*c+o],["L",t+f*d+m,n+i*c+o],["L",t+f*d,n+i*c],["Z"]],h=[["M",t+u*l,n+r*p],["L",t+u*l+m,n+r*p+o],["L",t+f*l+m,n+i*p+o],["L",t+f*l,n+i*p],["Z"]],y=Math.atan2(o,-m),e=Math.abs(a+y),d=Math.abs(s+y),c=Math.abs((s+a)/2+y);function v(e){return e=(e%=2*Math.PI)>Math.PI?2*Math.PI-e:e}e=v(e),d=v(d),u=1e5*v(c),r=1e5*d,t=1e5*e;return{top:M,zTop:1e5*Math.PI+1,out:P,zOut:Math.max(u,r,t),inn:b,zInn:Math.max(u,r,t),side1:x,zSide1:.99*t,side2:h,zSide2:.99*r}}}export default SVGRenderer3D;