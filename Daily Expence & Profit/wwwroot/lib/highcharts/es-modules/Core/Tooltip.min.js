"use strict";import F from"./FormatUtilities.js";const format=F["format"];import H from"./Globals.js";const{doc,isSafari}=H;import R from"./Renderer/RendererUtilities.js";const distribute=R["distribute"];import RendererRegistry from"./Renderer/RendererRegistry.js";import U from"./Utilities.js";const{addEvent,clamp,css,discardElement,extend,fireEvent,isArray,isNumber,isString,merge,pick,splat,syncTimeout}=U;class Tooltip{constructor(t,e){this.allowShared=!0,this.container=void 0,this.crosshairs=[],this.distance=0,this.isHidden=!0,this.isSticky=!1,this.now={},this.options={},this.outside=!1,this.chart=t,this.init(t,e)}bodyFormatter(t){return t.map(function(t){const e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})}cleanSplit(i){this.chart.series.forEach(function(t){const e=t&&t.tt;e&&(!e.isActive||i?t.tt=e.destroy():e.isActive=!1)})}defaultFormatter(t){var e=this.points||splat(this);let i;return(i=(i=[t.tooltipFooterHeaderFormatter(e[0])]).concat(t.bodyFormatter(e))).push(t.tooltipFooterHeaderFormatter(e[0],!0)),i}destroy(){this.label&&(this.label=this.label.destroy()),this.split&&(this.cleanSplit(!0),this.tt&&(this.tt=this.tt.destroy())),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),U.clearTimeout(this.hideTimer),U.clearTimeout(this.tooltipTimeout)}getAnchor(t,o){const e=this.chart,i=e.pointer,s=e.inverted,r=e.plotTop,a=e.plotLeft;let l;if((t=splat(t))[0].series&&t[0].series.yAxis&&!t[0].series.yAxis.options.reversedStacks&&(t=t.slice().reverse()),this.followPointer&&o)void 0===o.chartX&&(o=i.normalize(o)),l=[o.chartX-a,o.chartY-r];else if(t[0].tooltipPos)l=t[0].tooltipPos;else{let e=0,i=0;t.forEach(function(t){t=t.pos(!0);t&&(e+=t[0],i+=t[1])}),e/=t.length,i/=t.length,this.shared&&1<t.length&&o&&(s?e=o.chartX:i=o.chartY),l=[e-a,i-r]}return l.map(Math.round)}getClassName(t,e,i){const o=this.options,s=t.series,r=s.options;return[o.className,"highcharts-label",i&&"highcharts-tooltip-header",e?"highcharts-tooltip-box":"highcharts-tooltip",!i&&"highcharts-color-"+pick(t.colorIndex,s.colorIndex),r&&r.className].filter(isString).join(" ")}getLabel(){const e=this,t=this.chart.styledMode,i=this.options,o=this.split&&this.allowShared,s=i.style.pointerEvents||(this.shouldStickOnContact()?"auto":"none");let r,a=this.chart.renderer;var l;if(this.label&&(l=!this.label.hasClass("highcharts-label"),(!o&&l||o&&!l)&&this.destroy()),!this.label){if(this.outside){const h=this.chart.options.chart.style,n=RendererRegistry.getRendererType();this.container=r=H.doc.createElement("div"),r.className="highcharts-tooltip-container",css(r,{position:"absolute",top:"1px",pointerEvents:s,zIndex:Math.max(this.options.style.zIndex||0,(h&&h.zIndex||0)+3)}),H.doc.body.appendChild(r),this.renderer=a=new n(r,0,0,h,void 0,void 0,a.styledMode)}if(o?this.label=a.g("tooltip"):(this.label=a.label("",0,0,i.shape,void 0,void 0,i.useHTML,void 0,"tooltip").attr({padding:i.padding,r:i.borderRadius}),t||this.label.attr({fill:i.backgroundColor,"stroke-width":i.borderWidth||0}).css(i.style).css({pointerEvents:s})),e.outside){const c=this.label,{xSetter:d,ySetter:p}=c;c.xSetter=function(t){d.call(c,e.distance),r.style.left=t+"px"},c.ySetter=function(t){p.call(c,e.distance),r.style.top=t+"px"}}this.label.attr({zIndex:8}).shadow(i.shadow).add()}return this.label}getPlayingField(){var{body:t,documentElement:e}=doc,{chart:i,distance:o,outside:s}=this;return{width:s?Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,e.clientWidth)-2*o:i.chartWidth,height:s?Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,e.clientHeight):i.chartHeight}}getPosition(i,o,s){const r=this.chart,p=this.distance,f={},u=r.inverted&&s.h||0,g=this.outside,t=this.getPlayingField(),a=t.width,l=t.height,h=r.pointer.getChartPosition(),m=t=>t*h.scaleX,x=t=>t*h.scaleY,e=t=>{var e="x"===t;return[t,e?a:l,e?i:o].concat(g?[e?m(i):x(o),e?h.left-p+m(s.plotX+r.plotLeft):h.top-p+x(s.plotY+r.plotTop),0,e?a:l]:[e?i:o,e?s.plotX+r.plotLeft:s.plotY+r.plotTop,e?r.plotLeft:r.plotTop,e?r.plotLeft+r.plotWidth:r.plotTop+r.plotHeight])};let n=e("y"),c=e("x"),d,y=!!s.negative;!r.polar&&r.hoverSeries&&r.hoverSeries.yAxis&&r.hoverSeries.yAxis.reversed&&(y=!y);const b=!this.followPointer&&pick(s.ttBelow,!r.inverted===y),v=function(t,e,i,o,s,r,a){var l=g?("y"===t?x:m)(p):p,h=(i-o)/2,n=o<s-p,c=s+p+o<e,d=s-l-i+h,s=s+l-h;if(b&&c)f[t]=s;else if(!b&&n)f[t]=d;else if(n)f[t]=Math.min(a-o,d-u<0?d:d-u);else{if(!c)return!1;f[t]=Math.max(r,s+u+i>e?s:s+u)}},T=function(t,e,i,o,s){let r;return s<p||s>e-p?r=!1:f[t]=s<i/2?1:e-o/2<s?e-o-2:s-i/2,r},w=function(t){var e=n;n=c,c=e,d=t},S=function(){!1!==v.apply(0,n)?!1!==T.apply(0,c)||d||(w(!0),S()):d?f.x=f.y=0:(w(!0),S())};return(r.inverted||1<this.len)&&w(),S(),f}hide(t){const e=this;U.clearTimeout(this.hideTimer),t=pick(t,this.options.hideDelay),this.isHidden||(this.hideTimer=syncTimeout(function(){e.getLabel().fadeOut(t&&void 0),e.isHidden=!0},t))}init(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.now={x:0,y:0},this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))}shouldStickOnContact(t){return!(this.followPointer||!this.options.stickOnContact||t&&!this.chart.pointer.inClass(t.target,"highcharts-tooltip"))}move(t,e,i,o){const s=this,r=s.now,a=!1!==s.options.animation&&!s.isHidden&&(1<Math.abs(t-r.x)||1<Math.abs(e-r.y)),l=s.followPointer||1<s.len;extend(r,{x:a?(2*r.x+t)/3:t,y:a?(r.y+e)/2:e,anchorX:l?void 0:a?(2*r.anchorX+i)/3:i,anchorY:l?void 0:a?(r.anchorY+o)/2:o}),s.getLabel().attr(r),s.drawTracker(),a&&(U.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){s&&s.move(t,e,i,o)},32))}refresh(t,o){const s=this,r=this.chart,a=s.options,l=r.pointer,h=splat(t),n=h[0],e=[],i=a.formatter||s.defaultFormatter,c=s.shared,d=r.styledMode;let p={};if(a.enabled&&n.series){U.clearTimeout(this.hideTimer),s.allowShared=!(!isArray(t)&&t.series&&t.series.noSharedTooltip),s.followPointer=!s.split&&n.series.tooltipOptions.followPointer;var t=s.getAnchor(t,o),f=t[0],u=t[1];c&&s.allowShared?(l.applyInactiveState(h),h.forEach(function(t){t.setState("hover"),e.push(t.getLabelConfig())}),(p={x:n.category,y:n.y}).points=e):p=n.getLabelConfig(),this.len=e.length;const m=i.call(p,s);var g=n.series;if(this.distance=pick(g.tooltipOptions.distance,16),!1===m)this.hide();else{if(s.split&&s.allowShared)this.renderSplit(m,h);else{let e=f,i=u;if(o&&l.isDirectTouch&&(e=o.chartX-r.plotLeft,i=o.chartY-r.plotTop),!r.polar&&!1!==g.options.clip&&!h.some(t=>l.isDirectTouch||t.series.shouldShowTooltip(e,i)))return void s.hide();{const x=s.getLabel();a.style.width&&!d||x.css({width:(this.outside?this.getPlayingField():r.spacingBox).width+"px"}),x.attr({text:m&&m.join?m.join(""):m}),x.addClass(s.getClassName(n),!0),d||x.attr({stroke:a.borderColor||n.color||g.color||"#666666"}),s.updatePosition({plotX:f,plotY:u,negative:n.negative,ttBelow:n.ttBelow,h:t[2]||0})}}s.isHidden&&s.label&&s.label.attr({opacity:1}).show(),s.isHidden=!1}fireEvent(this,"refresh")}}renderSplit(t,c){const d=this,{chart:e,chart:{chartWidth:i,chartHeight:o,plotHeight:p,plotLeft:f,plotTop:u,pointer:s,scrollablePixelsY:r=0,scrollablePixelsX:a,scrollingContainer:{scrollLeft:l,scrollTop:h}={scrollLeft:0,scrollTop:0},styledMode:g},distance:m,options:x,options:{positioner:y}}=d,b=d.outside&&"number"!=typeof a?doc.documentElement.getBoundingClientRect():{left:l,right:l+i,top:h,bottom:h+o},v=d.getLabel(),T=this.renderer||e.renderer,w=Boolean(e.xAxis[0]&&e.xAxis[0].opposite),{left:n,top:S}=s.getChartPosition();let k=u+h,H,M=p-r;function X(t,e,i,o,s=!0){let r,a;return{x:a=i?(r=w?0:M,clamp(t-o/2,b.left,b.right-o-(d.outside?n:0))):(r=e-k,a=s?t-o-m:t+m,clamp(a,s?a:b.left,b.right)),y:r}}let F=(t=isString(t)?[!1,t]:t).slice(0,c.length+1).reduce(function(t,e,i){if(!1!==e&&""!==e){var i=c[i-1]||{isHeader:!0,plotX:c[0].plotX,plotY:p,series:{}},o=i.isHeader;const h=o?d:i.series,n=h.tt=function(t,e,i){var o;let s=t;var{isHeader:t,series:r}=e;if(!s){const a={padding:x.padding,r:x.borderRadius};g||(a.fill=x.backgroundColor,a["stroke-width"]=null!=(o=x.borderWidth)?o:1),s=T.label("",0,0,x[t?"headerShape":"shape"],void 0,void 0,x.useHTML).addClass(d.getClassName(e,!0,t)).attr(a).add(v)}return s.isActive=!0,s.attr({text:i}),g||s.css(x.style).attr({stroke:x.borderColor||e.color||r.color||"#333333"}),s}(h.tt,i,e.toString());var s,e=n.getBBox(),r=e.width+n.strokeWidth(),{anchorX:a,anchorY:l}=(o&&(H=e.height,M+=H,w&&(k-=H)),function(t){const{isHeader:e,plotX:i=0,plotY:o=0,series:s}=t;let r,a;var l;return e?(r=f+i,a=u+p/2):({xAxis:t,yAxis:l}=s,r=t.pos+clamp(i,-m,t.len+m),s.shouldShowTooltip(0,l.pos-u+o,{ignoreX:!0})&&(a=l.pos+o)),{anchorX:r=clamp(r,b.left-m,b.right+m),anchorY:a}}(i));"number"==typeof l?(e=e.height+1,s=y?y.call(d,r,e,i):X(a,l,o,r),t.push({align:y?0:void 0,anchorX:a,anchorY:l,boxWidth:r,point:i,rank:pick(s.rank,o?1:0),size:e,target:s.y,tt:n,x:s.x})):n.isActive=!1}return t},[]);!y&&F.some(t=>{var e=d["outside"],e=(e?n:0)+t.anchorX;return e<b.left&&e+t.boxWidth<b.right||e<n-b.left+t.boxWidth&&b.right-e>e})&&(F=F.map(t=>{var{x:e,y:i}=X(t.anchorX,t.anchorY,t.point.isHeader,t.boxWidth,!1);return extend(t,{target:i,x:e})})),d.cleanSplit(),distribute(F,M);const P={left:n,right:n},{container:C,outside:L,renderer:Y}=(F.forEach(function(t){var{x:t,boxWidth:e,isHeader:i}=t;i||(d.outside&&n+t<P.left&&(P.left=n+t),!i&&d.outside&&P.left+e>P.right&&(P.right=n+t))}),F.forEach(function(t){var{x:e,anchorX:i,anchorY:o,pos:s,point:{isHeader:r}}=t;const a={visibility:void 0===s?"hidden":"inherit",x:e,y:(s||0)+k,anchorX:i,anchorY:o};d.outside&&e<i&&(0<(s=n-P.left)&&(r||(a.x=e+s,a.anchorX=i+s),r&&(a.x=(P.right-P.left)/2,a.anchorX=i+s))),t.tt.attr(a)}),d);var E,A,W;L&&C&&Y&&({width:t,height:E,x:A,y:W}=v.getBBox(),Y.setSize(t+A,E+W,!1),C.style.left=P.left+"px",C.style.top=S+"px"),isSafari&&v.attr({opacity:1===v.opacity?.999:1})}drawTracker(){var t=this;if(this.shouldStickOnContact()){var e=t.chart;const o=t.label;var i=t.shared?e.hoverPoints:e.hoverPoint;if(o&&i){const s={x:0,y:0,width:0,height:0},r=this.getAnchor(i);i=o.getBBox();r[0]+=e.plotLeft-o.translateX,r[1]+=e.plotTop-o.translateY,s.x=Math.min(0,r[0]),s.y=Math.min(0,r[1]),s.width=r[0]<0?Math.max(Math.abs(r[0]),i.width-r[0]):Math.max(Math.abs(r[0]),i.width),s.height=r[1]<0?Math.max(Math.abs(r[1]),i.height-Math.abs(r[1])):Math.max(Math.abs(r[1]),i.height),t.tracker?t.tracker.attr(s):(t.tracker=o.renderer.rect(s).addClass("highcharts-tracker").add(o),e.styledMode||t.tracker.attr({fill:"rgba(0,0,0,0)"}))}}else t.tracker&&(t.tracker=t.tracker.destroy())}styledModeFormat(t){return t.replace('style="font-size: 0.8em"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex} {series.options.className} {point.options.className}"')}tooltipFooterHeaderFormatter(e,t){const i=e.series,o=i.tooltipOptions,s=i.xAxis,r=s&&s.dateTime,a={isFooter:t,labelConfig:e};let l=o.xDateFormat,h=o[t?"footerFormat":"headerFormat"];return fireEvent(this,"headerFormatter",a,function(t){r&&!l&&isNumber(e.key)&&(l=r.getXDateFormat(e.key,o.dateTimeLabelFormats)),r&&l&&(e.point&&e.point.tooltipDateKeys||["key"]).forEach(function(t){h=h.replace("{point."+t+"}","{point."+t+":"+l+"}")}),i.chart.styledMode&&(h=this.styledModeFormat(h)),t.text=format(h,{point:e,series:i},this.chart)}),a.text}update(t){this.destroy(),merge(!0,this.chart.options.tooltip.userOptions,t),this.init(this.chart,merge(!0,this.options,t))}updatePosition(t){const{chart:e,distance:i,options:o}=this,s=e.pointer,r=this.getLabel(),{left:a,top:l,scaleX:h,scaleY:n}=s.getChartPosition(),c=(o.positioner||this.getPosition).call(this,r.width,r.height,t);let d=(t.plotX||0)+e.plotLeft,p=(t.plotY||0)+e.plotTop,f;this.outside&&(o.positioner&&(c.x+=a-i,c.y+=l-i),f=(o.borderWidth||0)+2*i,this.renderer.setSize(r.width+f,r.height+f,!1),1===h&&1===n||(css(this.container,{transform:`scale(${h}, ${n})`}),d*=h,p*=n),d+=a-c.x,p+=l-c.y),this.move(Math.round(c.x),Math.round(c.y||0),d,p)}}!function(e){const i=[];e.compose=function(t){U.pushUnique(i,t)&&addEvent(t,"afterInit",function(){const t=this.chart;t.options.tooltip&&(t.tooltip=new e(t,t.options.tooltip))})}}(Tooltip=Tooltip||{});export default Tooltip;