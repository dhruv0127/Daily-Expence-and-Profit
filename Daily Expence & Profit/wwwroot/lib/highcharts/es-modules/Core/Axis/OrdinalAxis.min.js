"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import Series from"../Series/Series.js";import U from"../Utilities.js";const{addEvent,correctFloat,css,defined,error,pick,timeUnits}=U,composedMembers=[];var OrdinalAxis;!function(e){function n(t,i,r,o,e=[],n=0,s){const a={},l=this.options.tickPixelInterval,d=this.chart.time,c=[];let p,h,f,g,u,x=0,v=[],m=-Number.MAX_VALUE;if(!this.options.ordinal&&!this.options.breaks||!e||e.length<3||void 0===i)return d.getTimeTicks.apply(d,arguments);var P=e.length;for(p=0;p<P;p++){if(u=p&&e[p-1]>r,e[p]<i&&(x=p),p===P-1||e[p+1]-e[p]>5*n||u){if(e[p]>m){for(h=d.getTimeTicks(t,e[x],e[p],o);h.length&&h[0]<=m;)h.shift();h.length&&(m=h[h.length-1]),c.push(v.length),v=v.concat(h)}x=p+1}if(u)break}if(h){if(g=h.info,s&&g.unitRange<=timeUnits.hour){for(p=v.length-1,x=1;x<p;x++)d.dateFormat("%d",v[x])!==d.dateFormat("%d",v[x-1])&&(a[v[x]]="day",f=!0);f&&(a[v[0]]="day"),g.higherRanks=a}g.segmentStarts=c,v.info=g}else error(12,!1,this.chart);if(s&&defined(l)){const M=v.length,O=[],A=[];let t,i,o,e,n,s=M;for(;s--;)i=this.translate(v[s]),o&&(A[s]=o-i),O[s]=o=i;for(A.sort(),(e=A[Math.floor(A.length/2)])<.6*l&&(e=null),s=v[M-1]>r?M-1:M,o=void 0;s--;)i=O[s],n=Math.abs(o-i),o&&n<.8*l&&(null===e||n<.8*e)?(a[v[s]]&&!a[v[s+1]]?(t=s+1,o=i):t=s,v.splice(t,1)):o=i}return v}function s(t){var i=this.ordinal.positions;if(!i)return t;let o=i.length-1,e;return t<0?t=i[0]:t>o?t=i[o]:(o=Math.floor(t),e=t-o),void 0!==e&&void 0!==i[o]?i[o]+(e?e*(i[o+1]-i[o]):0):t}function r(t){const i=this,o=i.ordinal,e=(i.old||i).min,n=(i.old||i).transA;let s=o.positions;if(!s)return t;var r=(t-e)*n+i.minPixelPadding;if(0<r&&r<i.left+i.len||(o.extendedOrdinalPositions||(o.extendedOrdinalPositions=o.getExtendedPositions()),s=o.extendedOrdinalPositions),s&&s.length){var r=o.getIndexOfPoint(r,s),a=correctFloat(r%1);if(0<=r&&r<s.length-1)return l=s[Math.floor(r)],l=s[Math.ceil(r)]-l,s[Math.floor(r)]+a*l;var a=s.length,l=s[0],d=s[a-1],c=(d-l)/(a-1);return r<0?l+c*r:d+c*(r-a)}return t}function d(t,i){var o=e.Additions.findIndexOf(t,i,!0);return t[o]===i?o:o+(i-t[o])/(t[o+1]-t[o])}function a(){this.ordinal||(this.ordinal=new e.Additions(this))}function l(){var t=this;t.isXAxis&&defined(t.options.overscroll)&&t.max===t.dataMax&&(!t.chart.mouseIsDown||t.isInternal)&&(!t.eventArgs||t.eventArgs&&"navigator"!==t.eventArgs.trigger)&&(t.max+=t.options.overscroll,!t.isInternal&&defined(t.userMin)&&(t.min+=t.options.overscroll))}function c(){var t=this;t.horiz&&!t.isDirty&&(t.isDirty=t.isOrdinal&&t.chart.navigator&&!t.chart.navigator.adaptToUpdatedData)}function p(){var t=this;t.ordinal&&(t.ordinal.beforeSetTickPositions(),t.tickInterval=t.ordinal.postProcessTickInterval(t.tickInterval))}function h(t){const n=this,s=n.xAxis[0],r=s.options.overscroll,a=t.originalEvent.chartX,i=n.options.chart.panning;let l=!1;if(i&&"y"!==i.type&&s.options.ordinal&&s.series.length){const d=n.mouseDownX,c=s.getExtremes(),p=c.dataMax,h=c.min,f=c.max,g=n.hoverPoints,u=s.closestPointRange||s.ordinal&&s.ordinal.overscrollPointsRange,x=s.translationSlope*(s.ordinal.slope||u),v=(d-a)/x,m=s.ordinal.getExtendedPositions(),P={ordinal:{positions:m,extendedOrdinalPositions:m}},M=s.index2val,O=s.val2lin;let t,i,o,e;P.ordinal.positions?1<Math.abs(v)&&(g&&g.forEach(function(t){t.setState()}),e=v<0?(o=P,s.ordinal.positions?s:P):(o=s.ordinal.positions?s:P,P),p>(i=e.ordinal.positions)[i.length-1]&&i.push(p),n.fixedRange=f-h,(t=s.navigatorAxis.toFixedRange(void 0,void 0,M.apply(o,[O.apply(o,[h,!0])+v]),M.apply(e,[O.apply(e,[f,!0])+v]))).min>=Math.min(c.dataMin,h)&&t.max<=Math.max(p,f)+r&&s.setExtremes(t.min,t.max,!0,!1,{trigger:"pan"}),n.mouseDownX=a,css(n.container,{cursor:"move"})):l=!0}else l=!0;l||i&&/y/.test(i.type)?r&&(s.max=s.dataMax+r):t.preventDefault()}function f(){const t=this.xAxis;t&&t.options.ordinal&&(delete t.ordinal.index,delete t.ordinal.extendedOrdinalPositions)}function g(t,i){const o=this.ordinal,e=o.positions;let n=o.slope,s=o.extendedOrdinalPositions;if(!e)return t;var r=e.length;let a;if(e[0]<=t&&e[r-1]>=t)a=d(e,t);else{if(s||(s=o.getExtendedPositions&&o.getExtendedPositions(),o.extendedOrdinalPositions=s),!s||!s.length)return t;var r=s.length,l=(n=n||(s[r-1]-s[0])/r,d(s,e[0]));a=t>=s[0]&&t<=s[r-1]?d(s,t)-l:t<s[0]?-l-(s[0]-t)/n:(t-s[r-1])/n+r-l}return i?a:n*(a||0)+o.offset}e.compose=function(t,i,o){if(U.pushUnique(composedMembers,t)){const e=t.prototype;e.getTimeTicks=n,e.index2val=s,e.lin2val=r,e.val2lin=g,e.ordinal2lin=e.val2lin,addEvent(t,"afterInit",a),addEvent(t,"foundExtremes",l),addEvent(t,"afterSetScale",c),addEvent(t,"initialAxisTranslation",p)}return U.pushUnique(composedMembers,o)&&addEvent(o,"pan",h),U.pushUnique(composedMembers,i)&&addEvent(i,"updatedData",f),t};class u{constructor(t){this.index={},this.axis=t}beforeSetTickPositions(){const t=this.axis,i=t.ordinal,o=t.getExtremes(),e=o.min,n=o.max,s=t.isXAxis&&!!t.options.breaks,r=t.options.ordinal,a=t.chart.options.chart.ignoreHiddenSeries;let l,d,c,p,h,f,g,u=[],x=Number.MAX_VALUE,v=!1,m=!1,P=!1;if(r||s){let o=0;if(t.series.forEach(function(t,i){if(d=[],0<i&&"highcharts-navigator-series"!==t.options.id&&1<t.processedXData.length&&(m=o!==t.processedXData[1]-t.processedXData[0]),o=t.processedXData[1]-t.processedXData[0],t.boosted&&(P=t.boosted),(!a||!1!==t.visible)&&(!1!==t.takeOrdinalPosition||s)&&(u=u.concat(t.processedXData),l=u.length,u.sort(function(t,i){return t-i}),x=Math.min(x,pick(t.closestPointRange,x)),l)){for(i=0;i<l-1;)u[i]!==u[i+1]&&d.push(u[i+1]),i++;d[0]!==u[0]&&d.unshift(u[0]),u=d}}),m&&P&&(u.pop(),u.shift()),2<(l=u.length)){for(c=u[1]-u[0],g=l-1;g--&&!v;)u[g+1]-u[g]!=c&&(v=!0);!t.options.keepOrdinalPadding&&(u[0]-e>c||n-u[u.length-1]>c)&&(v=!0)}else t.options.overscroll&&(2===l?x=u[1]-u[0]:1===l?(x=t.options.overscroll,u=[u[0],u[0]+x]):x=i.overscrollPointsRange);v||t.forceOrdinal?(t.options.overscroll&&(i.overscrollPointsRange=x,u=u.concat(i.getOverscrollPositions())),i.positions=u,p=t.ordinal2lin(Math.max(e,u[0]),!0),h=Math.max(t.ordinal2lin(Math.min(n,u[u.length-1]),!0),1),i.slope=f=(n-e)/(h-p),i.offset=e-p*f):(i.overscrollPointsRange=pick(t.closestPointRange,i.overscrollPointsRange),i.positions=t.ordinal.slope=i.offset=void 0)}t.isOrdinal=r&&v,i.groupIntervalFactor=null}static findIndexOf(t,i,o){let e=0,n=t.length-1,s;for(;e<n;)t[s=Math.ceil((e+n)/2)]<=i?e=s:n=s-1;return t[e]===i||o?e:-1}getExtendedPositions(){const i=this,t=i.axis,o=t.constructor.prototype,e=t.chart,n=t.series[0].currentDataGrouping,s=n?n.count+n.unitName:"raw",r=t.options.overscroll,a=t.getExtremes();let l,d=void 0,c=i.index;return(c=c||(i.index={}))[s]||((l={series:[],chart:e,forceOrdinal:!1,getExtremes:function(){return{min:a.dataMin,max:a.dataMax+r}},getGroupPixelWidth:o.getGroupPixelWidth,getTimeTicks:o.getTimeTicks,options:{ordinal:!0},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:o.ordinal2lin,getIndexOfPoint:o.getIndexOfPoint,val2lin:o.val2lin}).ordinal.axis=l,t.series.forEach(function(t){(d={xAxis:l,xData:t.xData.slice(),chart:e,destroyGroupedData:H.noop,getProcessedData:Series.prototype.getProcessedData,applyGrouping:Series.prototype.applyGrouping}).xData=d.xData.concat(i.getOverscrollPositions()),d.options={dataGrouping:n?{firstAnchor:"firstPoint",anchor:"middle",lastAnchor:"lastPoint",enabled:!0,forced:!0,approximation:"open",units:[[n.unitName,[n.count]]]}:{enabled:!1}},l.series.push(d),t.processData.apply(d)}),d.closestPointRange!==d.basePointRange&&d.currentDataGrouping&&(l.forceOrdinal=!0),t.ordinal.beforeSetTickPositions.apply({axis:l}),c[s]=l.ordinal.positions),c[s]}getGroupIntervalFactor(t,i,o){this.axis;const e=o.processedXData,n=e.length,s=[];let r,a,l=this.groupIntervalFactor;if(!l){for(a=0;a<n-1;a++)s[a]=e[a+1]-e[a];s.sort(function(t,i){return t-i}),r=s[Math.floor(n/2)],t=Math.max(t,e[0]),i=Math.min(i,e[n-1]),this.groupIntervalFactor=l=n*r/(i-t)}return l}getIndexOfPoint(t,i){const o=this,e=o.axis,n=o.positions?o.positions[0]:0;let s=e.series[0].points&&e.series[0].points[0]&&e.series[0].points[0].plotX||e.minPixelPadding;1<e.series.length&&e.series.forEach(function(t){t.points&&defined(t.points[0])&&defined(t.points[0].plotX)&&t.points[0].plotX<s&&t.points[0].plotX>=pick(e.min,-1/0)&&(s=t.points[0].plotX)});var r=e.translationSlope*(o.slope||e.closestPointRange||o.overscrollPointsRange),t=(t-s)/r;return u.findIndexOf(i,n)+t}getOverscrollPositions(){const t=this.axis,i=t.options.overscroll,o=this.overscrollPointsRange,e=[];let n=t.dataMax;if(defined(o))for(;n<=t.dataMax+i;)n+=o,e.push(n);return e}postProcessTickInterval(t){var i=this.axis,o=this.slope;let e;return e=o?i.options.breaks?i.closestPointRange||t:t/(o/i.closestPointRange):t}}e.Additions=u}(OrdinalAxis=OrdinalAxis||{});export default OrdinalAxis;