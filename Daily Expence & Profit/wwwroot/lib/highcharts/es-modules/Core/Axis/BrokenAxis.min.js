"use strict";import StackItem from"./Stacking/StackItem.js";import U from"../Utilities.js";const{addEvent,find,fireEvent,isArray,isNumber,pick}=U;var BrokenAxis;!function(i){const e=[];function n(){void 0!==this.brokenAxis&&this.brokenAxis.setBreaks(this.options.breaks,!1)}function r(){var i=this;i.brokenAxis&&i.brokenAxis.hasBreaks&&(i.options.ordinal=!1)}function o(){const i=this,t=i.brokenAxis;if(t&&t.hasBreaks){const s=i.tickPositions,e=i.tickPositions.info,n=[];for(let i=0;i<s.length;i++)t.isInAnyBreak(s[i])||n.push(s[i]);i.tickPositions=n,i.tickPositions.info=e}}function a(){var i=this;i.brokenAxis||(i.brokenAxis=new h(i))}function f(){const{isDirty:i,options:{connectNulls:t},points:s,xAxis:e,yAxis:n}=this;if(i){let i=s.length;for(;i--;){const o=s[i];var r=!(null===o.y&&!1===t)&&(e&&e.brokenAxis&&e.brokenAxis.isInAnyBreak(o.x,!0)||n&&n.brokenAxis&&n.brokenAxis.isInAnyBreak(o.y,!0));o.visible=!r&&!1!==o.options.visible}}}function c(){this.drawBreaks(this.xAxis,["x"]),this.drawBreaks(this.yAxis,pick(this.pointArrayMap,["y"]))}function k(s,i){const t=this,e=t.points;let n,r,o,a;if(s&&s.brokenAxis&&s.brokenAxis.hasBreaks){const f=s.brokenAxis;i.forEach(function(i){n=f&&f.breakArray||[],r=s.isXAxis?s.min:pick(t.options.threshold,s.min),e.forEach(function(t){a=pick(t["stack"+i.toUpperCase()],t[i]),n.forEach(function(i){isNumber(r)&&isNumber(a)&&(o=!1,r<i.from&&a>i.to||r>i.from&&a<i.from?o="pointBreak":(r<i.from&&a>i.from&&a<i.to||r>i.from&&a>i.to&&a<i.from)&&(o="pointInBreak"),o&&fireEvent(s,o,{point:t,brk:i}))})})})}}function u(){const i=this.currentDataGrouping,s=i&&i.gapSize,e=this.points.slice(),n=this.yAxis;let r=this.options.gapSize,o=e.length-1,a;if(r&&0<o){"value"!==this.options.gapUnit&&(r*=this.basePointRange),s&&s>r&&s>=this.basePointRange&&(r=s);let i,t;for(;o--;){var f;t&&!1!==t.visible||(t=e[o+1]),i=e[o],!1!==t.visible&&!1!==i.visible&&(t.x-i.x>r&&(f=(i.x+t.x)/2,e.splice(o+1,0,{isNull:!0,x:f}),n.stacking&&this.options.stacking&&((a=n.stacking.stacks[this.stackKey][f]=new StackItem(n,n.options.stackLabels,!1,f,this.stack)).total=0)),t=i)}}return this.getGraphPath(e)}i.compose=function(i,t){if(U.pushUnique(e,i)&&(i.keepProps.push("brokenAxis"),addEvent(i,"init",a),addEvent(i,"afterInit",n),addEvent(i,"afterSetTickPositions",o),addEvent(i,"afterSetOptions",r)),U.pushUnique(e,t)){const s=t.prototype;s.drawBreaks=k,s.gappedPath=u,addEvent(t,"afterGeneratePoints",f),addEvent(t,"afterRender",c)}return i};class h{static isInBreak(i,t){var s=i.repeat||1/0,e=i.from,n=i.to-i.from,e=e<=t?(t-e)%s:s-(e-t)%s;let r;return r=i.inclusive?e<=n:e<n&&0!=e}static lin2Val(i){var t=this.brokenAxis,s=t&&t.breakArray;if(!s||!isNumber(i))return i;let e=i,n,r;for(r=0;r<s.length&&!((n=s[r]).from>=e);r++)(n.to<e||h.isInBreak(n,e))&&(e+=n.len);return e}static val2Lin(i){var t=this.brokenAxis,s=t&&t.breakArray;if(!s||!isNumber(i))return i;let e=i,n,r;for(r=0;r<s.length;r++)if((n=s[r]).to<=i)e-=n.len;else{if(n.from>=i)break;if(h.isInBreak(n,i)){e-=i-n.from;break}}return e}constructor(i){this.hasBreaks=!1,this.axis=i}findBreakAt(t,i){return find(i,function(i){return i.from<t&&t<i.to})}isInAnyBreak(i,t){var s=this.axis,e=s.options.breaks||[];let n=e.length,r,o,a;if(n&&isNumber(i)){for(;n--;)h.isInBreak(e[n],i)&&(r=!0,o=o||pick(e[n].showPoints,!s.isXAxis));a=r&&t?r&&!o:r}return a}setBreaks(i,t){const u=this,l=u.axis;var s=isArray(i)&&!!i.length;l.isDirty=u.hasBreaks!==s,u.hasBreaks=s,l.options.breaks=l.userOptions.breaks=i,l.forceRedraw=!0,l.series.forEach(function(i){i.isDirty=!0}),s||l.val2lin!==h.val2Lin||(delete l.val2lin,delete l.lin2val),s&&(l.userOptions.ordinal=!1,l.lin2val=h.lin2Val,l.val2lin=h.val2Lin,l.setExtremes=function(t,s,i,e,n){if(u.hasBreaks){var r=this.options.breaks||[];let i;for(;i=u.findBreakAt(t,r);)t=i.to;for(;i=u.findBreakAt(s,r);)s=i.from;s<t&&(s=t)}l.constructor.prototype.setExtremes.call(this,t,s,i,e,n)},l.setAxisTranslation=function(){if(l.constructor.prototype.setAxisTranslation.call(this),u.unitLength=void 0,u.hasBreaks){const i=l.options.breaks||[],f=[],c=[],k=pick(l.pointRangePadding,0);let t=0,s,e,n=l.userMin||l.min,r=l.userMax||l.max,o,a;i.forEach(function(i){e=i.repeat||1/0,isNumber(n)&&isNumber(r)&&(h.isInBreak(i,n)&&(n+=i.to%e-n%e),h.isInBreak(i,r)&&(r-=r%e-i.from%e))}),i.forEach(function(i){if(o=i.from,e=i.repeat||1/0,isNumber(n)&&isNumber(r)){for(;o-e>n;)o-=e;for(;o<n;)o+=e;for(a=o;a<r;a+=e)f.push({value:a,move:"in"}),f.push({value:a+i.to-i.from,move:"out",size:i.breakSize})}}),f.sort(function(i,t){return i.value===t.value?("in"===i.move?0:1)-("in"===t.move?0:1):i.value-t.value}),s=0,o=n,f.forEach(function(i){1===(s+="in"===i.move?1:-1)&&"in"===i.move&&(o=i.value),0===s&&isNumber(o)&&(c.push({from:o,to:i.value,len:i.value-o-(i.size||0)}),t+=i.value-o-(i.size||0))}),u.breakArray=c,isNumber(n)&&isNumber(r)&&isNumber(l.min)&&(u.unitLength=r-n-t+k,fireEvent(l,"afterBreaks"),l.staticScale?l.transA=l.staticScale:u.unitLength&&(l.transA*=(r-l.min+k)/u.unitLength),k&&(l.minPixelPadding=l.transA*(l.minPointOffset||0)),l.min=n,l.max=r)}}),pick(t,!0)&&l.chart.redraw()}}i.Additions=h}(BrokenAxis=BrokenAxis||{});export default BrokenAxis;