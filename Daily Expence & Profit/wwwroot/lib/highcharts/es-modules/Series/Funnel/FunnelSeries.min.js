"use strict";import Chart from"../../Core/Chart/Chart.js";import H from"../../Core/Globals.js";const noop=H["noop"];import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{series:Series,seriesTypes:{pie:PieSeries}}=SeriesRegistry;import U from"../../Core/Utilities.js";const{addEvent,extend,fireEvent,isArray,merge,pick}=U;class FunnelSeries extends PieSeries{constructor(){super(...arguments),this.data=void 0,this.options=void 0,this.points=void 0}alignDataLabel(e,t,i,a,s){let o=e.series,n=o.options.reversed,r=e.dlBox||e.shapeArgs,l=i.align,d=i.verticalAlign,h=((o.options||{}).dataLabels||{}).inside,p=o.center[1],c=n?2*p-e.plotY:e.plotY,g=o.getWidthAt(c-r.height/2+t.height),b="middle"===d?(r.topWidth-r.bottomWidth)/4:(g-r.bottomWidth)/2,u=r.y,f=r.x;var m=pick(t.height,t.getBBox().height);"middle"===d?u=r.y-r.height/2+m/2:"top"===d&&(u=r.y-r.height+m+i.padding),("top"===d&&!n||"bottom"===d&&n||"middle"===d)&&("right"===l?f=r.x-i.padding+b:"left"===l&&(f=r.x+i.padding-b)),a={x:f,y:n?u-r.height:u,width:r.bottomWidth,height:r.height},i.verticalAlign="bottom",h&&!e.visible||Series.prototype.alignDataLabel.call(this,e,t,i,a,s),h&&(!e.visible&&e.dataLabel&&(e.dataLabel.placed=!1),e.contrastColor&&t.css({color:e.contrastColor}))}drawDataLabels(){let e=this,t=e.data,i=e.options.dataLabels.distance,a,s,o,n=t.length,r,l;for(e.center[2]-=2*i;n--;)s=(a=(o=t[n]).half)?1:-1,l=o.plotY,o.labelDistance=pick(o.options.dataLabels&&o.options.dataLabels.distance,i),e.maxLabelDistance=Math.max(o.labelDistance,e.maxLabelDistance||0),r=e.getX(l,a,o),o.labelPosition={natural:{x:0,y:l},computed:{},alignment:a?"right":"left",connectorPosition:{breakAt:{x:r+(o.labelDistance-5)*s,y:l},touchingSliceAt:{x:r+o.labelDistance*s,y:l}}};SeriesRegistry.seriesTypes[e.options.dataLabels.inside?"column":"pie"].prototype.drawDataLabels.call(this)}translate(){let t=0,a=this,e=a.chart,i=a.options,s=i.reversed,o=i.ignoreHiddenPoint,n=e.plotWidth,r=e.plotHeight,l=0,d=i.center,h=H(d[0],n),p=H(d[1],r),c=H(i.width,n),g,b=H(i.height,r),u=H(i.neckWidth,n),f=H(i.neckHeight,r),m=p-b/2+b-f,y=a.data,L,v,x="left"===i.dataLabels.position?1:0,S,A,W,D,C,k,E;function H(e,t){return/%$/.test(e)?t*parseInt(e,10)/100:parseInt(e,10)}a.getWidthAt=function(e){var t=p-b/2;return e>m||b===f?u:u+(c-u)*(1-(e-t)/(b-f))},a.getX=function(e,t,i){return h+(t?-1:1)*(a.getWidthAt(s?2*p-e:e)/2+i.labelDistance)},a.center=[h,p,b],a.centerX=h,y.forEach(function(e){!e.y||!e.isValid()||o&&!1===e.visible||(t+=e.y)}),y.forEach(function(e){E=null,v=t?e.y/t:0,A=p-b/2+l*b,C=A+v*b,g=a.getWidthAt(A),S=h-g/2,W=S+g,g=a.getWidthAt(C),D=h-g/2,k=D+g,A>m?(S=D=h-u/2,W=k=h+u/2):C>m&&(E=C,g=a.getWidthAt(m),D=h-g/2,k=D+g,C=m),s&&(A=2*p-A,C=2*p-C,null!==E&&(E=2*p-E)),L=[["M",S,A],["L",W,A],["L",k,C]],null!==E&&L.push(["L",k,E],["L",D,E]),L.push(["L",D,C],["Z"]),e.shapeType="path",e.shapeArgs={d:L},e.percentage=100*v,e.plotX=h,e.plotY=(A+(E||C))/2,e.tooltipPos=[h,e.plotY],e.dlBox={x:D,y:A,topWidth:W-S,bottomWidth:k-D,height:Math.abs(pick(E,C)-A),width:NaN},e.slice=noop,e.half=x,!e.isValid()||o&&!1===e.visible||(l+=v)}),fireEvent(a,"afterTranslate")}sortByAngle(e){e.sort(function(e,t){return e.plotY-t.plotY})}}FunnelSeries.defaultOptions=merge(PieSeries.defaultOptions,{animation:!1,center:["50%","50%"],width:"90%",neckWidth:"30%",height:"100%",neckHeight:"25%",reversed:!1,size:!0,dataLabels:{connectorWidth:1,verticalAlign:"middle"},states:{select:{color:"#cccccc",borderColor:"#000000"}}}),extend(FunnelSeries.prototype,{animate:noop}),addEvent(Chart,"afterHideAllOverlappingLabels",function(){this.series.forEach(function(e){let t=e.options&&e.options.dataLabels;isArray(t)&&(t=t[0]),e.is("pie")&&e.placeDataLabels&&t&&!t.inside&&e.placeDataLabels()})}),SeriesRegistry.registerSeriesType("funnel",FunnelSeries);export default FunnelSeries;