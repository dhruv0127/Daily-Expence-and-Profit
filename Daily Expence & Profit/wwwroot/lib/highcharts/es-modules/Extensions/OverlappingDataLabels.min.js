"use strict";import Chart from"../Core/Chart/Chart.js";import U from"../Core/Utilities.js";const{addEvent,fireEvent,isArray,isNumber,objectEach,pick}=U;function hideOrShow(t,a){let e,i,n=!1;return t&&(i=t.newOpacity,t.oldOpacity!==i&&(t.alignAttr&&t.placed?(t[i?"removeClass":"addClass"]("highcharts-data-label-hidden"),e=function(){a.styledMode||t.css({pointerEvents:i?"auto":"none"})},n=!0,t.alignAttr.opacity=i,t[t.isOld?"animate":"attr"](t.alignAttr,null,e),fireEvent(a,"afterHideOverlappingLabel")):t.attr({opacity:i})),t.isOld=!0),n}addEvent(Chart,"render",function(){let i=this,n=[];(this.labelCollectors||[]).forEach(function(t){n=n.concat(t())}),(this.yAxis||[]).forEach(function(t){t.stacking&&t.options.stackLabels&&!t.options.stackLabels.allowOverlap&&objectEach(t.stacking.stacks,function(t){objectEach(t,function(t){t.label&&n.push(t.label)})})}),(this.series||[]).forEach(function(t){var a=t.options.dataLabels;t.visible&&(!1!==a.enabled||t._hasPointLabels)&&((a=t=>t.forEach(e=>{if(e.visible){const t=isArray(e.dataLabels)?e.dataLabels:e.dataLabel?[e.dataLabel]:[];t.forEach(function(t){var a=t.options;t.labelrank=pick(a.labelrank,e.labelrank,e.shapeArgs&&e.shapeArgs.height),a.allowOverlap?(t.oldOpacity=t.opacity,t.newOpacity=1,hideOrShow(t,i)):n.push(t)})}}))(t.nodes||[]),a(t.points))}),this.hideOverlappingLabels(n)}),Chart.prototype.hideOverlappingLabels=function(t){let a=this,e=t.length,h=a.renderer,i,n,r,l,o,s,c,d=!1;for(n=0;n<e;n++)(i=t[n])&&(i.oldOpacity=i.opacity,i.newOpacity=1,i.absoluteBox=function(t){let a,e,i,n=!t.box&&t.padding||0,r=0,l=0,o,s;if(t&&(!t.alignAttr||t.placed))return a=t.alignAttr||{x:t.attr("x"),y:t.attr("y")},e=t.parentGroup,t.width||(i=t.getBBox(),t.width=i.width,t.height=i.height,r=h.fontMetrics(t.element).h),o=t.width-2*n,(s={left:"0",center:"0.5",right:"1"}[t.alignValue])?l=+s*o:isNumber(t.x)&&Math.round(t.x)!==t.translateX&&(l=t.x-t.translateX),{x:a.x+(e.translateX||0)+n-(l||0),y:a.y+(e.translateY||0)+n-r,width:t.width-2*n,height:t.height-2*n}}(i));for(t.sort(function(t,a){return(a.labelrank||0)-(t.labelrank||0)}),n=0;n<e;n++)for(s=(l=t[n])&&l.absoluteBox,r=n+1;r<e;++r)o=t[r],c=o&&o.absoluteBox,s&&c&&l!==o&&0!==l.newOpacity&&0!==o.newOpacity&&"hidden"!==l.visibility&&"hidden"!==o.visibility&&(p=s,(b=c).x>=p.x+p.width||b.x+b.width<=p.x||b.y>=p.y+p.height||b.y+b.height<=p.y||((l.labelrank<o.labelrank?l:o).newOpacity=0));var p,b;t.forEach(function(t){hideOrShow(t,a)&&(d=!0)}),d&&fireEvent(a,"afterHideAllOverlappingLabels")};