"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import ExportDataDefaults from"./ExportDataDefaults.js";import H from"../../Core/Globals.js";const{doc,win}=H;import D from"../../Core/Defaults.js";const{getOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const downloadURL=DownloadURL["downloadURL"];import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{series:SeriesClass,seriesTypes:{arearange:AreaRangeSeries,gantt:GanttSeries,map:MapSeries,mapbubble:MapBubbleSeries,treemap:TreemapSeries}}=SeriesRegistry;import U from"../../Core/Utilities.js";const{addEvent,defined,extend,find,fireEvent,isNumber,pick}=U,composedMembers=[];function chartDownloadCSV(){var e=this.getCSV(!0);downloadURL(getBlobFromContent(e,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(e),this.getFilename()+".csv")}function chartDownloadXLS(){var e='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(getBlobFromContent(e,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(e=e,win.btoa(unescape(encodeURIComponent(e)))),this.getFilename()+".xls")}function chartGetCSV(e){let i="";const o=this.getDataRows(),t=this.options.exporting.csv,s=pick(t.decimalPoint,","!==t.itemDelimiter&&e?1.1.toLocaleString()[1]:"."),r=pick(t.itemDelimiter,","===s?";":","),l=t.lineDelimiter;return o.forEach((e,t)=>{let a="",n=e.length;for(;n--;)"number"==typeof(a="string"==typeof(a=e[n])?'"'+a+'"':a)&&"."!==s&&(a=a.toString().replace(".",s)),e[n]=a;e.length=o.length?o[0].length:0,i+=e.join(r),t<o.length-1&&(i+=l)}),i}function chartGetDataRows(i){function t(e,t,a){if(D.columnHeaderFormatter){var n=D.columnHeaderFormatter(e,t,a);if(!1!==n)return n}return e?e instanceof SeriesClass?i?{columnTitle:1<a?t:e.name,topLevelColumnTitle:e.name}:e.name+(1<a?" ("+t+")":""):e.options.title&&e.options.title.text||(e.dateTime?c:l):l}function x(a,e,n){const i={},o={};return e.forEach(function(e){var t=(a.keyToAxis&&a.keyToAxis[e]||e)+"Axis",t=isNumber(n)?a.chart[t][n]:a[t];i[e]=t&&t.categories||[],o[e]=t&&t.dateTime}),{categoryMap:i,dateTimeValueAxisMap:o}}const b=this.hasParallelCoordinates,T=this.time,D=this.options.exporting&&this.options.exporting.csv||{},a=this.xAxis,S={},e=[],n=[],o=[],s=this.options.lang,r=s.exportData,l=r.categoryHeader,c=r.categoryDatetimeHeader,w=[];let h,p,y,v=0,d,m;for(d in this.series.forEach(function(l){const e=l.options.keys,c=l.xAxis,h=e||function(e,t){if(!e.data.filter(e=>void 0!==e.y&&e.name).length||!t||t.categories||e.keyToAxis)return e.pointArrayMap||["y"];if(e.pointArrayMap&&e.pointArrayMap.filter(e=>"x"===e).length)return e.pointArrayMap.unshift("x"),e.pointArrayMap;return["x","y"]}(l,c),p=h.length,d=!l.requireSorting&&{},m=a.indexOf(c);let u=x(l,h),f,g;if(!1!==l.options.includeInDataExport&&!l.options.isInternal&&!1!==l.visible){for(find(w,function(e){return e[0]===m})||w.push([m,v]),g=0;g<p;)y=t(l,h[g],h.length),o.push(y.columnTitle||y),i&&n.push(y.topLevelColumnTitle||y),g++;f={chart:l.chart,autoIncrement:l.autoIncrement,options:l.options,pointArrayMap:l.pointArrayMap,index:l.index},l.options.data.forEach(function(e,t){var a={series:f};let n,i,o;if(b&&(u=x(l,h,t)),l.pointClass.prototype.applyOptions.apply(a,[e]),n=a.x,defined(S[n])&&S[n].seriesIndices.includes(f.index)){const s=Object.keys(S).filter(e=>S[e].seriesIndices.includes(f.index)&&n),r=s.filter(e=>0===e.indexOf(String(n)));n=n.toString()+","+r.length}e=l.data[t]&&l.data[t].name;for(g=0,(!c||"name"===l.exportKey||!b&&c&&c.hasNames&&e)&&(n=e),d&&(d[n]&&(n+="|"+t),d[n]=!0),S[n]||(S[n]=[],S[n].xValues=[]),S[n].x=a.x,S[n].name=e,S[n].xValues[m]=a.x,defined(S[n].seriesIndices)||(S[n].seriesIndices=[]),S[n].seriesIndices=[...S[n].seriesIndices,f.index];g<p;)o=a[i=h[g]],S[n][v+g]=pick(u.categoryMap[i][o],u.dateTimeValueAxisMap[i]?T.dateFormat(D.dateFormat,o):null,o),g++}),v+=g}}),S)Object.hasOwnProperty.call(S,d)&&e.push(S[d]);let u,f;for(p=i?[n,o]:[o],v=w.length;v--;)u=w[v][0],f=w[v][1],h=a[u],e.sort(function(e,t){return e.xValues[u]-t.xValues[u]}),m=t(h),p[0].splice(f,0,m),i&&p[1]&&p[1].splice(f,0,m),e.forEach(function(e){let t=e.name;h&&!defined(t)&&(t=h.dateTime?(e.x instanceof Date&&(e.x=e.x.getTime()),T.dateFormat(D.dateFormat,e.x)):h.categories?pick(h.names[e.x],h.categories[e.x],e.x):e.x),e.splice(f,0,t)});return p=p.concat(e),fireEvent(this,"exportData",{dataRows:p}),p}function chartGetTable(e){const t=e=>{if(!e.tagName||"#text"===e.tagName)return e.textContent||"";const a=e.attributes;let n="<"+e.tagName;return a&&Object.keys(a).forEach(e=>{var t=a[e];n+=` ${e}="${t}"`}),n=(n+=">")+(e.textContent||""),(e.children||[]).forEach(e=>{n+=t(e)}),n+=`</${e.tagName}>`};e=this.getTableAST(e);return t(e)}function chartGetTableAST(e){let n=0;const t=[],d=this.options,s=e?1.1.toLocaleString()[1]:".",m=pick(d.exporting.useMultiLevelHeaders,!0),a=this.getDataRows(m),i=m?a.shift():null,o=a.shift(),u=function(e,t){let a=e.length;if(t.length!==a)return!1;for(;a--;)if(e[a]!==t[a])return!1;return!0},f=function(e,t,a,n){let i=pick(n,""),o="highcharts-text"+(t?" "+t:"");return"number"==typeof i?(i=i.toString(),","===s&&(i=i.replace(".",s)),o="highcharts-number"):n||(o="highcharts-empty"),{tagName:e,attributes:a=extend({class:o},a),textContent:i}};!1!==d.exporting.tableCaption&&t.push({tagName:"caption",attributes:{class:"highcharts-table-caption"},textContent:pick(d.exporting.tableCaption,d.title.text||"Chart")});for(let e=0,t=a.length;e<t;++e)a[e].length>n&&(n=a[e].length);t.push(function(e,t,a){const n=[];let i=0,o=a||t&&t.length,s,r=0,l;if(m&&e&&t&&!u(e,t)){const c=[];for(;i<o;++i)if((s=e[i])===e[i+1])++r;else if(r)c.push(f("th","highcharts-table-topheading",{scope:"col",colspan:r+1},s)),r=0;else{s===t[i]?d.exporting.useRowspanHeaders?(l=2,delete t[i]):(l=1,t[i]=""):l=1;const h=f("th","highcharts-table-topheading",{scope:"col"},s);1<l&&h.attributes&&(h.attributes.valign="top",h.attributes.rowspan=l),c.push(h)}n.push({tagName:"tr",children:c})}if(t){const p=[];for(i=0,o=t.length;i<o;++i)void 0!==t[i]&&p.push(f("th",null,{scope:"col"},t[i]));n.push({tagName:"tr",children:p})}return{tagName:"thead",children:n}}(i,o,Math.max(n,o.length)));const r=[];a.forEach(function(t){const a=[];for(let e=0;e<n;e++)a.push(f(e?"td":"th",null,e?{}:{scope:"row"},t[e]));r.push({tagName:"tr",children:a})}),t.push({tagName:"tbody",children:r});e={tree:{tagName:"table",id:"highcharts-data-table-"+this.index,children:t}};return fireEvent(this,"aftergetTableAST",e),e.tree}function chartHideData(){this.toggleDataTable(!1)}function chartToggleDataTable(e){var t=(e=pick(e,!this.isDataTableVisible))&&!this.dataTableDiv;if(t&&(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling)),this.dataTableDiv){const s=this.dataTableDiv.style,r=s.display;if(s.display=e?"block":"none",e){this.dataTableDiv.innerHTML=AST.emptyHTML;const l=new AST([this.getTableAST()]);l.addToDOM(this.dataTableDiv),fireEvent(this,"afterViewData",{element:this.dataTableDiv,wasHidden:t||r!==s.display})}}this.isDataTableVisible=e;const a=this.exportDivElements,n=this.options.exporting,i=n&&n.buttons&&n.buttons.contextButton.menuItems,o=this.options.lang;n&&n.menuItemDefinitions&&o&&o.viewData&&o.hideData&&i&&a&&((t=a[i.indexOf("viewData")])&&AST.setElementHTML(t,this.isDataTableVisible?o.hideData:o.viewData))}function chartViewData(){this.toggleDataTable(!0)}function compose(e){if(U.pushUnique(composedMembers,e)){addEvent(e,"afterViewData",onChartAfterViewData),addEvent(e,"render",onChartRenderer);const t=e.prototype;t.downloadCSV=chartDownloadCSV,t.downloadXLS=chartDownloadXLS,t.getCSV=chartGetCSV,t.getDataRows=chartGetDataRows,t.getTable=chartGetTable,t.getTableAST=chartGetTableAST,t.hideData=chartHideData,t.toggleDataTable=chartToggleDataTable,t.viewData=chartViewData}if(U.pushUnique(composedMembers,setOptions)){const a=getOptions().exporting;a&&(extend(a.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){this.toggleDataTable()}}}),a.buttons&&a.buttons.contextButton.menuItems&&a.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")),setOptions(ExportDataDefaults)}AreaRangeSeries&&U.pushUnique(composedMembers,AreaRangeSeries)&&(AreaRangeSeries.prototype.keyToAxis={low:"y",high:"y"}),GanttSeries&&U.pushUnique(composedMembers,GanttSeries)&&(GanttSeries.prototype.keyToAxis={start:"x",end:"x"}),MapSeries&&U.pushUnique(composedMembers,MapSeries)&&(MapSeries.prototype.exportKey="name"),MapBubbleSeries&&U.pushUnique(composedMembers,MapBubbleSeries)&&(MapBubbleSeries.prototype.exportKey="name"),TreemapSeries&&U.pushUnique(composedMembers,TreemapSeries)&&(TreemapSeries.prototype.exportKey="name")}function getBlobFromContent(e,t){const a=win.navigator,n=-1<a.userAgent.indexOf("WebKit")&&a.userAgent.indexOf("Chrome")<0,i=win.URL||win.webkitURL||win;try{if(a.msSaveOrOpenBlob&&win.MSBlobBuilder){const o=new win.MSBlobBuilder;return o.append(e),o.getBlob("image/svg+xml")}if(!n)return i.createObjectURL(new win.Blob(["\ufeff"+e],{type:t}))}catch(e){}}function onChartAfterViewData(){const i=this,o=i.dataTableDiv,s=(e,t)=>e.children[t].textContent,r=(n,i)=>(e,t)=>{var a;return a=s(i?e:t,n),t=s(i?t:e,n),""===a||""===t||isNaN(a)||isNaN(t)?a.toString().localeCompare(t):a-t};if(o&&i.options.exporting&&i.options.exporting.allowTableSorting){const e=o.querySelector("thead tr");e&&e.childNodes.forEach(a=>{const n=a.closest("table");a.addEventListener("click",function(){const e=[...o.querySelectorAll("tr:not(thead tr)")],t=[...a.parentNode.children];e.sort(r(t.indexOf(a),i.ascendingOrderInTable=!i.ascendingOrderInTable)).forEach(e=>{n.appendChild(e)}),t.forEach(t=>{["highcharts-sort-ascending","highcharts-sort-descending"].forEach(e=>{t.classList.contains(e)&&t.classList.remove(e)})}),a.classList.add(i.ascendingOrderInTable?"highcharts-sort-ascending":"highcharts-sort-descending")})})}}function onChartRenderer(){this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport&&this.viewData()}const ExportData={compose:compose};export default ExportData;