"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import D from"../../Core/Defaults.js";const defaultOptions=D["defaultOptions"];import DownloadURL from"../DownloadURL.js";const downloadURL=DownloadURL["downloadURL"];import Exporting from"../Exporting/Exporting.js";import H from"../../Core/Globals.js";const{win,doc}=H;import HU from"../../Core/HttpUtilities.js";const ajax=HU["ajax"];import OfflineExportingDefaults from"./OfflineExportingDefaults.js";import U from"../../Core/Utilities.js";const{addEvent,error,extend,fireEvent,merge}=U,composedMembers=(AST.allowedAttributes.push("data-z-index","fill-opacity","rx","ry","stroke-dasharray","stroke-linejoin","text-anchor","transform","version","viewBox","visibility","xmlns","xmlns:xlink"),AST.allowedTags.push("desc","clippath","g"),[]);var OfflineExporting;!function(u){function o(t,e){const o=this,n=merge(o.options.exporting,t),r=function(t){!1===n.fallbackToExportServer?n.error?n.error(n,t):error(28,!0):o.exportChart(n)};H.isMS&&o.styledMode&&!Exporting.inlineAllowlist.length&&Exporting.inlineAllowlist.push(/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/),H.isMS&&("application/pdf"===n.type||o.container.getElementsByTagName("image").length&&"image/svg+xml"!==n.type)||"application/pdf"===n.type&&[].some.call(o.container.getElementsByTagName("image"),function(t){const e=t.getAttribute("href");return""!==e&&"string"==typeof e&&0!==e.indexOf("data:")})?r(new Error("Image type not supported for this chart/browser.")):o.getSVGForLocalExport(n,e||{},r,function(t){-1<t.indexOf("<foreignObject")&&"image/svg+xml"!==n.type&&(H.isMS||"application/pdf"===n.type)?r(new Error("Image type not supported for charts with embedded HTML")):u.downloadSVGLocal(t,extend({filename:o.getFilename()},n),r,()=>fireEvent(o,"exportChartLocalSuccess"))})}function x(t,e){const o=doc.getElementsByTagName("head")[0],n=doc.createElement("script");n.type="text/javascript",n.src=t,n.onload=e,n.onerror=function(){error("Error loading script "+t)},o.appendChild(n)}function n(e,t,o,n){const r=this,i=t=>r.sanitizeSVG(t,d),a=()=>{g&&m===p&&n(i(c.innerHTML))},l=(t,e,o)=>{++m,o.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",t),a()};let s,c,d,f,g,p=0,m=0;r.unbindGetSVG=addEvent(r,"getSVG",t=>{d=t.chartCopy.options,c=t.chartCopy.container.cloneNode(!0),g=c&&c.getElementsByTagName("image")||[],p=g.length}),r.getSVGForExport(e,t);try{if(!g||!g.length)return void n(i(c.innerHTML));for(let t=0;t<g.length;t++)s=g[t],(f=s.getAttributeNS("http://www.w3.org/1999/xlink","href"))?u.imageToDataUrl(f,"image/png",{imageElement:s},e.scale,l,o,o,o):(m++,s.parentNode.removeChild(s),t--,a())}catch(t){o(t)}r.unbindGetSVG()}function r(n,r,i,a,l,t,s,e,c){let d=new win.Image,f;const o=()=>{setTimeout(function(){const t=doc.createElement("canvas"),e=t.getContext&&t.getContext("2d");var o;try{if(e){t.height=d.height*a,t.width=d.width*a,e.drawImage(d,0,0,t.width,t.height);try{o=t.toDataURL(r),l(o,r,i,a)}catch(t){f(n,r,i,a)}}else s(n,r,i,a)}finally{c&&c(n,r,i,a)}},u.loadEventDeferDelay)},g=()=>{e(n,r,i,a),c&&c(n,r,i,a)};f=()=>{d=new win.Image,f=t,d.crossOrigin="Anonymous",d.onload=o,d.onerror=g,d.src=n},d.onload=o,d.onerror=g,d.src=n}function y(t){const e=win.navigator.userAgent;var o=-1<e.indexOf("WebKit")&&e.indexOf("Chrome")<0;try{if(!o&&-1===t.indexOf("<foreignObject"))return u.domurl.createObjectURL(new win.Blob([t],{type:"image/svg+xml;charset-utf-16"}))}catch(t){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(t)}function w(t,e,o){const n=Number(t.getAttribute("width"))+2*e,r=Number(t.getAttribute("height"))+2*e,i=new win.jspdf.jsPDF(n<r?"p":"l","pt",[n,r]);[].forEach.call(t.querySelectorAll('*[visibility="hidden"]'),function(t){t.parentNode.removeChild(t)});var a=t.querySelectorAll("linearGradient");for(let e=0;e<a.length;e++){const l=a[e],s=l.querySelectorAll("stop");let t=0;for(;t<s.length&&"0"===s[t].getAttribute("offset")&&"0"===s[t+1].getAttribute("offset");)s[t].remove(),t++}[].forEach.call(t.querySelectorAll("tspan"),t=>{"â€‹"===t.textContent&&(t.textContent=" ",t.setAttribute("dx",-5))}),i.svg(t,{x:0,y:0,width:n,height:r,removeInvalid:!0}).then(()=>o(i.output("datauristring")))}u.CanVGRenderer={},u.domurl=win.URL||win.webkitURL||win,u.loadEventDeferDelay=H.isMS?150:0,u.compose=function(t){if(U.pushUnique(composedMembers,t)){const e=t.prototype;e.getSVGForLocalExport=n,e.exportChartLocal=o,merge(!0,defaultOptions.exporting,OfflineExportingDefaults)}return t},u.downloadSVGLocal=function(c,t,d,f){const g=doc.createElement("div"),i=t.type||"image/png",p=(t.filename||"chart")+"."+("image/svg+xml"===i?"svg":i.split("/")[1]),a=t.scale||1;let e,o,l,s=t.libURL||defaultOptions.exporting.libURL,m=!0,h=t.pdfFont;s="/"!==s.slice(-1)?s+"/":s;const n=()=>{AST.setElementHTML(g,c);const t=g.getElementsByTagName("text");let e;[].forEach.call(t,function(r){["fontFamily","fontSize"].forEach(t=>{{var o=r,n=t;let e=o;for(;e&&e!==g;){if(e.style[n]){let t=e.style[n];"fontSize"===n&&/em$/.test(t)&&(t=Math.round(16*parseFloat(t))+"px"),o.style[n]=t;break}e=e.parentNode}return}}),r.style.fontFamily=h&&h.normal?"HighchartsFont":String(r.style.fontFamily&&r.style.fontFamily.split(" ").splice(-1)),e=r.getElementsByTagName("title"),[].forEach.call(e,function(t){r.removeChild(t)})});const o=g.querySelector("svg");if(o){var n=o;var i=()=>{w(o,0,t=>{try{downloadURL(t,p),f&&f()}catch(t){d(t)}})};const a=(t,e)=>{win.jspdf.jsPDF.API.events.push(["initialized",function(){this.addFileToVFS(t,e),this.addFont(t,"HighchartsFont",t),this.getFontList().HighchartsFont||this.setFont("HighchartsFont")}])},l=(h&&!/[^\u0000-\u007F\u200B]+/.test(n.textContent||"")&&(h=void 0),["normal","italic","bold","bolditalic"]);let r;const s=()=>{const n=l.shift();if(!n)return i();var t=h&&h[n];t?ajax({url:t,responseType:"blob",success:(t,e)=>{const o=new FileReader;o.onloadend=function(){var t;"string"==typeof this.result&&(t=this.result.split(",")[1],a(n,t),"normal"===n&&(r=t)),s()},o.readAsDataURL(e.response)},error:s}):(r&&a(n,r),s())};s()}};if("image/svg+xml"===i)try{e=void 0!==win.MSBlobBuilder?((o=new win.MSBlobBuilder).append(c),o.getBlob("image/svg+xml")):y(c),downloadURL(e,p),f&&f()}catch(t){d(t)}else"application/pdf"===i?win.jspdf&&win.jspdf.jsPDF?n():(m=!0,x(s+"jspdf.js",function(){x(s+"svg2pdf.js",n)})):(e=y(c),l=function(){try{u.domurl.revokeObjectURL(e)}catch(t){}},r(e,i,{},a,function(t){try{downloadURL(t,p),f&&f()}catch(t){d(t)}},function(){function t(){const t=win.canvg.Canvg.fromString(o,c);t.start();try{downloadURL(win.navigator.msSaveOrOpenBlob?e.msToBlob():e.toDataURL(i),p),f&&f()}catch(t){d(t)}finally{l()}}const e=doc.createElement("canvas"),o=e.getContext("2d"),n=c.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*a,r=c.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*a;e.width=n,e.height=r,win.canvg?t():(m=!0,x(s+"canvg.js",function(){t()}))},d,d,function(){m&&l()}))},u.getScript=x,u.imageToDataUrl=r,u.svgToDataUrl=y,u.svgToPdf=w}(OfflineExporting=OfflineExporting||{});export default OfflineExporting;