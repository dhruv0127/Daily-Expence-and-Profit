"use strict";import BoostChart from"./Boost/BoostChart.js";const{getBoostClipRect,isChartSeriesBoosting}=BoostChart;import BoostSeries from"./Boost/BoostSeries.js";const destroyGraphics=BoostSeries["destroyGraphics"];import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";const color=Color["parse"];import H from"../Core/Globals.js";const{doc,noop}=H;import Series from"../Core/Series/Series.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";const seriesTypes=SeriesRegistry["seriesTypes"];import U from"../Core/Utilities.js";const{addEvent,extend,fireEvent,isNumber,merge,pick,wrap}=U,b64BlankPixel="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";let CHUNK_SIZE=5e4,destroyLoadingDiv;const initCanvasBoost=function(){H.seriesTypes.heatmap&&wrap(H.seriesTypes.heatmap.prototype,"drawPoints",function(){const n=this.chart,c=this.getContext(),l=this.chart.inverted,p=this.xAxis,h=this.yAxis;c?(this.points.forEach(function(t){let e=t.plotY,o;var i,s,r,a;void 0!==e&&!isNaN(e)&&null!==t.y&&c&&({x:i=0,y:s=0,width:r=0,height:a=0}=t.shapeArgs||{},o=n.styledMode?t.series.colorAttribs(t):t.series.pointAttribs(t),c.fillStyle=o.fill,l?c.fillRect(h.len-s+p.left,p.len-i+h.top,-a,-r):c.fillRect(i+p.left,s+h.top,r,a))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}),extend(Series.prototype,{getContext:function(){const t=this.chart,e=isChartSeriesBoosting(t)?t:this,o=e===t?t.seriesGroup:t.seriesGroup||this.group;function i(t,e,o,i,s,r,a){t.call(this,o,e,i,s,r,a)}let s=t.chartWidth,r=t.chartHeight,a;const n=e.boost=e.boost||{};return a=n.targetCtx,n.canvas?e:(n.canvas=doc.createElement("canvas"),n.target=t.renderer.image("",0,0,s,r).addClass("highcharts-boost-canvas").add(o),a=n.targetCtx=n.canvas.getContext("2d"),t.inverted&&["moveTo","lineTo","rect","arc"].forEach(t=>{wrap(a,t,i)}),n.copy=function(){n.target.attr({href:n.canvas.toDataURL("image/png")})},n.clear=function(){a.clearRect(0,0,n.canvas.width,n.canvas.height),e===n.target&&n.target.attr({href:b64BlankPixel})},n.clipRect=t.renderer.clipRect(),n.target.clip(n.clipRect)),n.canvas.width!==s&&(n.canvas.width=s),n.canvas.height!==r&&(n.canvas.height=r),n.target.attr({x:0,y:0,width:s,height:r,style:"pointer-events: none",href:b64BlankPixel}),n.clipRect&&n.clipRect.attr(getBoostClipRect(t,e)),a},canvasToSVG:function(){isChartSeriesBoosting(this.chart)?this.boost&&this.boost.clear&&this.boost.clear():this.boost&&this.boost.copy?this.boost.copy():this.chart.boost&&this.chart.boost.copy&&this.chart.boost.copy()},cvsLineTo:function(t,e,o){t.lineTo(e,o)},renderCanvas:function(){function u(t,e,o,i){0===r&&(s.beginPath(),g&&(s.lineJoin="round")),m.scroller&&"highcharts-navigator-series"===y.options.className?(e+=m.scroller.top,o&&(o+=m.scroller.top)):e+=m.plotTop,t+=m.plotLeft,Z?s.moveTo(t,e):d?d(s,t,e,o,T):g?g(s,t,e):S&&S.call(y,s,t,e,h,i),(r+=1)===I&&($(),r=0),T={clientX:t,plotY:e,yBottom:o}}function v(t,e,o){G=tt?t:t+","+e,K&&!l[G]&&(l[G]=!0,m.inverted&&(t=f.len-t,e=b.len-e),p.push({x:!!et&&et[q+o],clientX:t,plotX:t,plotY:e,i:q+o}))}let y=this,t=y.options,m=y.chart,f=this.xAxis,b=this.yAxis,e=m.options.boost||{},o={timeRendering:e.timeRendering||!1,timeSeriesProcessing:e.timeSeriesProcessing||!1,timeSetup:e.timeSetup||!1},s,r=0,i=y.processedXData,j=y.processedYData,a=t.data,n=f.getExtremes(),C=n.min,A=n.max,c=b.getExtremes(),Y=c.min,H=c.max,l={},x,X=!!y.sampling,p,h=t.marker&&t.marker.radius,d=this.cvsDrawPoint,g=t.lineWidth?this.cvsLineTo:void 0,S=h&&h<=1?this.cvsMarkerSquare:this.cvsMarkerCircle,I=this.cvsStrokeBatch||1e3,K=!1!==t.enableMouseTracking,T,B=t.threshold,k=b.getThreshold(B),w=isNumber(B),R=k,O=this.fill,V=y.pointArrayMap&&"low,high"===y.pointArrayMap.join(","),W=!!t.stacking,q=y.cropStart||0,_=m.options.loading,Q=y.requireSorting,Z,z=t.connectNulls,J=!i,E,P,D,M,G,N=W?y.data:i||a,F=y.fillOpacity?Color.parse(y.color).setOpacity(pick(t.fillOpacity,.75)).get():y.color,$=function(){O?(s.fillStyle=F,s.fill()):(s.strokeStyle=y.color,s.lineWidth=t.lineWidth,s.stroke())},tt="x"===t.findNearestPointBy,et=this.xData||this.options.xData||this.processedXData||!1,L=this.boost||{};L.target&&L.target.attr({href:b64BlankPixel}),(this.points||this.graph)&&destroyGraphics(this),y.plotGroup("group","series",y.visible?"visible":"hidden",t.zIndex,m.seriesGroup),y.markerGroup=y.group,addEvent(y,"destroy",function(){y.markerGroup=null}),p=this.points=[],s=this.getContext(),y.buildKDTree=noop,L.clear&&L.clear(),this.visible&&(99999<a.length&&(m.options.loading=merge(_,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(destroyLoadingDiv),m.showLoading("Drawing..."),m.options.loading=_),o.timeRendering&&console.time("canvas rendering"),BoostSeries.eachAsync(N,function(t,e){let o,i,s,r,a,n,c=!1,l=!1,p=!1,h=!1,d=void 0===m.index,g=!0;return d||(J?(o=t[0],i=t[1],N[e+1]&&(p=N[e+1][0]),N[e-1]&&(h=N[e-1][0])):(o=t,i=j[e],N[e+1]&&(p=N[e+1]),N[e-1]&&(h=N[e-1])),p&&p>=C&&p<=A&&(c=!0),h&&h>=C&&h<=A&&(l=!0),V?(J&&(i=t.slice(1,3)),n=i[0],i=i[1]):W&&(o=t.x,i=t.stackY,n=i-t.y),a=null===i,Q||(g=i>=Y&&i<=H),!a&&(o>=C&&o<=A&&g||c||l)&&(s=Math.round(f.toPixels(o,!0)),X?(void 0!==D&&s!==x||(V||(n=i),(void 0===M||i>P)&&(P=i,M=e),(void 0===D||n<E)&&(E=n,D=e)),s!==x&&(void 0!==D&&(r=b.toPixels(P,!0),k=b.toPixels(E,!0),u(s,w?Math.min(r,R):r,w?Math.max(k,R):k,e),v(s,r,M),k!==r&&v(s,k,D)),D=M=void 0,x=s)):(r=Math.round(b.toPixels(i,!0)),u(s,r,k,e),v(s,r,e))),Z=a&&!z,e%CHUNK_SIZE==0&&(y.boost&&y.boost.copy?y.boost.copy():y.chart.boost&&y.chart.boost.copy&&y.chart.boost.copy())),!d},function(){const t=m.loadingDiv,e=m.loadingShown;$(),y.canvasToSVG(),o.timeRendering&&console.timeEnd("canvas rendering"),fireEvent(y,"renderedCanvas"),e&&(extend(t.style,{transition:"opacity 250ms",opacity:0}),m.loadingShown=!1,destroyLoadingDiv=setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),m.loadingDiv=m.loadingSpan=null},250)),delete y.buildKDTree,y.buildKDTree()},m.renderer.forExport?Number.MAX_VALUE:void 0))}}),seriesTypes.scatter.prototype.cvsMarkerCircle=function(t,e,o,i){t.moveTo(e,o),t.arc(e,o,i,0,2*Math.PI,!1)},seriesTypes.scatter.prototype.cvsMarkerSquare=function(t,e,o,i){t.rect(e-i,o-i,2*i,2*i)},seriesTypes.scatter.prototype.fill=!0,seriesTypes.bubble&&(seriesTypes.bubble.prototype.cvsMarkerCircle=function(t,e,o,i,s){t.moveTo(e,o),t.arc(e,o,this.radii&&this.radii[s],0,2*Math.PI,!1)},seriesTypes.bubble.prototype.cvsStrokeBatch=1),extend(seriesTypes.area.prototype,{cvsDrawPoint:function(t,e,o,i,s){s&&e!==s.clientX&&(t.moveTo(s.clientX,s.yBottom),t.lineTo(s.clientX,s.plotY),t.lineTo(e,o),t.lineTo(e,i))},fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{cvsDrawPoint:function(t,e,o,i){t.rect(e-1,o,1,i-o)},fill:!0,sampling:!0}),Chart.prototype.callbacks.push(function(t){addEvent(t,"predraw",function(){const t=this.boost||{};t.target&&t.target.attr({href:b64BlankPixel}),t.canvas&&t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height)}),addEvent(t,"render",function(){t.boost&&t.boost.copy&&t.boost.copy()})})};export default initCanvasBoost;