"use strict";import A from"../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";import ColumnSeries from"../Series/Column/ColumnSeries.js";import H from"../Core/Globals.js";const noop=H["noop"];import D from"../Core/Defaults.js";const defaultOptions=D["defaultOptions"];import Point from"../Core/Series/Point.js";import Series from"../Core/Series/Series.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";const seriesTypes=SeriesRegistry["seriesTypes"];import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import Tick from"../Core/Axis/Tick.js";import U from"../Core/Utilities.js";import"../Series/Column/ColumnSeries.js";import Breadcrumbs from"./Breadcrumbs/Breadcrumbs.js";const{addEvent,cleanRecursively,defined,extend,fireEvent,merge,objectEach,pick,removeEvent,syncTimeout}=U,PieSeries=seriesTypes.pie,MapSeries=seriesTypes.map;let ddSeriesId=1;extend(defaultOptions.lang,{}),defaultOptions.drilldown={activeAxisLabelStyle:{cursor:"pointer",color:"#0022ff",fontWeight:"bold",textDecoration:"underline"},activeDataLabelStyle:{cursor:"pointer",color:"#0022ff",fontWeight:"bold",textDecoration:"underline"},animation:{duration:500},drillUpButton:{position:{align:"right",x:-10,y:10}},mapZooming:!0},SVGRenderer.prototype.Element.prototype.fadeIn=function(e){this.attr({opacity:.1,visibility:"inherit"}).animate({opacity:pick(this.newOpacity,1)},e||{duration:250})},Chart.prototype.addSeriesAsDrilldown=function(i,o){const t=this;var e;if(t.mapView)if(i.series.isDrilling=!0,i.series.options.inactiveOtherPoints=!0,i.series.dataLabelsGroup&&(i.series.dataLabelsGroup.destroy(),delete i.series.dataLabelsGroup),t.options.drilldown&&!t.mapView.projection.hasGeoProjection&&defaultOptions.drilldown&&(e=cleanRecursively(t.options.drilldown,defaultOptions.drilldown),defined(e.mapZooming)||(t.options.drilldown.mapZooming=!1)),t.options.drilldown&&t.options.drilldown.animation&&t.options.drilldown.mapZooming){t.mapView.allowTransformAnimation=!0;const r=animObject(t.options.drilldown.animation);if("boolean"!=typeof r){const n=r.complete;r.complete=function(){n&&n.apply(this,arguments),function(e){e&&e.applyDrilldown&&t.mapView&&(t.addSingleSeriesAsDrilldown(i,o),t.applyDrilldown(),t.mapView.allowTransformAnimation=!1)}.apply(this,arguments)}}i.zoomTo(r)}else t.addSingleSeriesAsDrilldown(i,o),t.applyDrilldown();else t.addSingleSeriesAsDrilldown(i,o),t.applyDrilldown()},Chart.prototype.addSingleSeriesAsDrilldown=function(e,i){let o=e.series,t=o.xAxis,r=o.yAxis,n,s,l=[],a=[],d,p,c,h;h=this.styledMode?{colorIndex:pick(e.colorIndex,o.colorIndex)}:{color:e.color||o.color},this.drilldownLevels||(this.drilldownLevels=[]),p=o.options._levelNumber||0,(c=this.drilldownLevels[this.drilldownLevels.length-1])&&c.levelNumber!==p&&(c=void 0),i=extend(extend({_ddSeriesId:ddSeriesId++},h),i),s=o.points.indexOf(e),o.chart.series.forEach(function(e){e.xAxis===t&&(e.options._ddSeriesId=e.options._ddSeriesId||ddSeriesId++,e.options._colorIndex=e.userOptions._colorIndex,e.options._levelNumber=e.options._levelNumber||p,c?(l=c.levelSeries,a=c.levelSeriesOptions):(l.push(e),e.purgedOptions=merge({_ddSeriesId:e.options._ddSeriesId,_levelNumber:e.options._levelNumber,selected:e.options.selected},e.userOptions),a.push(e.purgedOptions)))}),d=extend({levelNumber:p,seriesOptions:o.options,seriesPurgedOptions:o.purgedOptions,levelSeriesOptions:a,levelSeries:l,shapeArgs:e.shapeArgs,bBox:e.graphic?e.graphic.getBBox():{},color:e.isNull?Color.parse(h.color).setOpacity(0).get():h.color,lowerSeriesOptions:i,pointOptions:o.options.data[s],pointIndex:s,oldExtremes:{xMin:t&&t.userMin,xMax:t&&t.userMax,yMin:r&&r.userMin,yMax:r&&r.userMax},resetZoomButton:c&&c.levelNumber===p?void 0:this.resetZoomButton},h),this.drilldownLevels.push(d),t&&t.names&&(t.names.length=0),(n=d.lowerSeries=this.addSeries(i,!1)).options._levelNumber=p+1,t&&(t.oldPos=t.pos,t.userMin=t.userMax=null,r.userMin=r.userMax=null),n.isDrilling=!0,o.type===n.type&&(n.animate=n.animateDrilldown||noop,n.options.animation=!0)},Chart.prototype.applyDrilldown=function(){const o=this,e=this.drilldownLevels;let t;e&&0<e.length&&(t=e[e.length-1].levelNumber,this.drilldownLevels.forEach(function(e){o.mapView&&o.options.drilldown&&o.options.drilldown.mapZooming&&(o.redraw(),e.lowerSeries.isDrilling=!1,o.mapView.fitToBounds(e.lowerSeries.bounds),e.lowerSeries.isDrilling=!0),e.levelNumber===t&&e.levelSeries.forEach(function(i,e){if(o.mapView){if(i.options&&i.options._levelNumber===t&&i.group){let e={};o.options.drilldown&&(e=o.options.drilldown.animation),i.group.animate({opacity:0},e,function(){i.remove(!1),o.resetZoomButton&&(o.resetZoomButton.hide(),delete o.resetZoomButton),o.pointer.reset(),fireEvent(o,"afterDrilldown"),o.mapView&&(o.series.forEach(e=>{e.isDirtyData=!0,e.isDrilling=!1}),o.mapView.fitToBounds(void 0,void 0)),fireEvent(o,"afterApplyDrilldown")})}}else i.options&&i.options._levelNumber===t&&i.remove(!1)})})),o.mapView||(this.resetZoomButton&&(this.resetZoomButton.hide(),delete this.resetZoomButton),this.pointer.reset(),fireEvent(this,"afterDrilldown"),this.redraw(),fireEvent(this,"afterApplyDrilldown"))};const createBreadcrumbsList=function(e){const t=[],i=e.drilldownLevels;return i&&i.length&&(t[0]||t.push({level:0,levelOptions:i[0].seriesOptions}),i.forEach(function(e,i){var o=t[t.length-1];e.levelNumber+1>o.level&&t.push({level:e.levelNumber+1,levelOptions:merge({name:e.lowerSeries.name},e.pointOptions)})})),t};function fadeInGroup(e){var i=animObject(this.chart.options.drilldown.animation);e&&(e.hide(),syncTimeout(function(){e&&e.added&&e.fadeIn()},Math.max(i.duration-50,0)))}Chart.prototype.drillUp=function(e){if(!this.drilldownLevels||0===this.drilldownLevels.length)return;fireEvent(this,"beforeDrillUp");const t=this,r=t.drilldownLevels,n=r[r.length-1].levelNumber,s=t.series,l=t.drilldownLevels.length,a=e=>{e.remove(!1),t.series.forEach(e=>{e.colorAxis&&(e.isDirtyData=!0),e.options.inactiveOtherPoints=!1}),t.redraw()};let d=r.length,p,c,h;for(;d--;){let i,o;if((c=r[d]).levelNumber===n){if(r.pop(),!(i=c.lowerSeries).chart)for(p=s.length;p--;)if(s[p].options.id===c.lowerSeriesOptions.id&&s[p].options._levelNumber===n+1){i=s[p];break}i.xData=[],i.xAxis&&i.xAxis.names&&(0===l||d===l)&&(i.xAxis.names.length=0),c.levelSeriesOptions.forEach(e=>{o=function(i,e){let o;if(s.forEach(function(e){e.options._ddSeriesId===i._ddSeriesId&&(o=e)}),(o=o||t.addSeries(i,!1)).type===e.type&&o.animateDrillupTo&&(o.animate=o.animateDrillupTo),i===c.seriesPurgedOptions)return o}(e,i)}),fireEvent(t,"drillup",{seriesOptions:c.seriesPurgedOptions||c.seriesOptions}),o&&(o.type===i.type&&(o.drilldownLevel=c,o.options.animation=t.options.drilldown.animation,i.animateDrillupFrom&&i.chart&&i.animateDrillupFrom(c)),o.options._levelNumber=n);const f=i;var u,m;t.mapView||f.remove(!1),o&&o.xAxis&&(h=c.oldExtremes,o.xAxis.setExtremes(h.xMin,h.xMax,!1),o.yAxis.setExtremes(h.yMin,h.yMax,!1)),c.resetZoomButton&&(t.resetZoomButton=c.resetZoomButton),this.mapView?(u=c.levelNumber===n&&e,m=t.options.drilldown&&t.options.drilldown.animation&&t.options.drilldown.mapZooming,u?i.remove(!1):(i.dataLabelsGroup&&(i.dataLabelsGroup.destroy(),delete i.dataLabelsGroup),t.mapView&&o&&(m&&(i.isDrilling=!0,o.isDrilling=!0,t.redraw(!1),t.mapView.fitToBounds(i.bounds,void 0,!0,!1)),t.mapView.allowTransformAnimation=!0,fireEvent(t,"afterDrillUp",{seriesOptions:o?o.userOptions:void 0}),m?t.mapView.setView(void 0,1,!0,{complete:function(){Object.prototype.hasOwnProperty.call(this,"complete")&&a(i)}}):(t.mapView.allowTransformAnimation=!1,i.group?i.group.animate({opacity:0},t.options.drilldown.animation,function(){a(i),t.mapView&&(t.mapView.allowTransformAnimation=!0)}):(a(i),t.mapView.allowTransformAnimation=!0)),o.isDrilling=!1,t.ddDupes&&(t.ddDupes.length=0),fireEvent(t,"drillupall")))):(fireEvent(t,"afterDrillUp"),this.redraw(),this.ddDupes&&(this.ddDupes.length=0),fireEvent(t,"drillupall"))}}},addEvent(Chart,"afterInit",function(){const o=this;o.drilldown={chart:o,fadeInGroup:fadeInGroup,update:function(e,i){merge(!0,o.options.drilldown,e),pick(i,!0)&&o.redraw()}}}),addEvent(Chart,"render",function(){(this.xAxis||[]).forEach(function(s){s.ddPoints={},s.series.forEach(function(e){let i,o=e.xData||[],t=e.points,r;for(i=0;i<o.length;i++){var n;"number"!=typeof(r=e.options.data[i])&&e.pointClass.prototype.optionsToObject.call({series:e},r).drilldown&&(s.ddPoints[o[i]]||(s.ddPoints[o[i]]=[]),n=i-(e.cropStart||0),s.ddPoints[o[i]].push(!(t&&0<=n&&n<t.length)||t[n]))}}),objectEach(s.ticks,Tick.prototype.drillable)})}),addEvent(Breadcrumbs,"up",function(e){const i=this.chart,o=this.getLevel()-e.newLevel;let t=1<o;for(let e=0;e<o;e++)e===o-1&&(t=!1),i.drillUp(t)}),addEvent(Chart,"afterDrilldown",function(){var e=this,i=e.options.drilldown,i=i&&i.breadcrumbs;e.breadcrumbs||(e.breadcrumbs=new Breadcrumbs(e,i)),e.breadcrumbs.updateProperties(createBreadcrumbsList(e))}),addEvent(Chart,"afterDrillUp",function(){this.breadcrumbs&&this.breadcrumbs.updateProperties(createBreadcrumbsList(this))}),addEvent(Chart,"update",function(e){const i=this.breadcrumbs,o=e.options.drilldown&&e.options.drilldown.breadcrumbs;i&&o&&i.update(e.options.drilldown.breadcrumbs)}),ColumnSeries.prototype.animateDrillupTo=function(e){if(!e){const o=this,n=o.drilldownLevel;this.points.forEach(function(e){const i=e.dataLabel;e.graphic&&e.graphic.hide(),i&&(i.hidden="hidden"===i.attr("visibility"),i.hidden||(i.hide(),e.connector&&e.connector.hide()))}),syncTimeout(function(){if(o.points){let i=[];o.data.forEach(function(e){i.push(e)}),(i=o.nodes?i.concat(o.nodes):i).forEach(function(e,i){const o=i===(n&&n.pointIndex)?"show":"fadeIn",t="show"==o||void 0,r=e.dataLabel;e.graphic&&e.visible&&e.graphic[o](t),r&&!r.hidden&&(r.fadeIn(),e.connector&&e.connector.fadeIn())})}},Math.max(this.chart.options.drilldown.animation.duration-50,0)),delete this.animate}},ColumnSeries.prototype.animateDrilldown=function(e){let o=this,i=this.chart,t=i.drilldownLevels,r,n=animObject(i.options.drilldown.animation),s=this.xAxis,l=i.styledMode;e||(t.forEach(function(e){o.options._ddSeriesId===e.lowerSeriesOptions._ddSeriesId&&(r=e.shapeArgs,l||(r.fill=e.color))}),r.x+=pick(s.oldPos,s.pos)-s.pos,this.points.forEach(function(e){const i=e.shapeArgs;l||(i.fill=e.color),e.graphic&&e.graphic.attr(r).animate(extend(e.shapeArgs,{fill:e.color||o.color}),n)}),i.drilldown&&i.drilldown.fadeInGroup(this.dataLabelsGroup),delete this.animate)},ColumnSeries.prototype.animateDrillupFrom=function(r){let n=animObject(this.chart.options.drilldown.animation),s=this.group,l=s!==this.chart.columnGroup,a=this;a.trackerGroups.forEach(function(e){a[e]&&a[e].on("mouseover")}),l&&delete this.group,this.points.forEach(function(e){function i(){o.destroy(),s&&l&&(s=s.destroy())}const o=e.graphic,t=r.shapeArgs;o&&t&&(delete e.graphic,a.chart.styledMode||(t.fill=r.color),n.duration?o.animate(t,merge(n,{complete:i})):(o.attr(t),i()))})},PieSeries&&extend(PieSeries.prototype,{animateDrillupTo:ColumnSeries.prototype.animateDrillupTo,animateDrillupFrom:ColumnSeries.prototype.animateDrillupFrom,animateDrilldown:function(e){const t=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],r=this.chart.options.drilldown.animation;if(this.is("item")&&(r.duration=0),this.center){const n=t.shapeArgs,s=n.start,i=n.end-s,l=i/this.points.length,a=this.chart.styledMode;e||(this.points.forEach(function(e,i){const o=e.shapeArgs;a||(n.fill=t.color,o.fill=e.color),e.graphic&&e.graphic.attr(merge(n,{start:s+i*l,end:s+(i+1)*l}))[r?"animate":"attr"](o,r)}),this.chart.drilldown&&this.chart.drilldown.fadeInGroup(this.dataLabelsGroup),delete this.animate)}}}),MapSeries&&extend(MapSeries.prototype,{animateDrilldown(e){const i=this,o=this.chart,t=this.group;o&&t&&i.options&&(e&&o.mapView?(t.attr({opacity:.01}),o.mapView.allowTransformAnimation=!1,i.options.inactiveOtherPoints=!0,i.options.enableMouseTracking=!1):(t.animate({opacity:1},o.options.drilldown.animation,function(){i.options&&(i.options.inactiveOtherPoints=!1,i.options.enableMouseTracking=pick(i.userOptions&&i.userOptions.enableMouseTracking,!0),i.isDirty=!0,o.redraw())}),o.drilldown&&o.drilldown.fadeInGroup(this.dataLabelsGroup)))},animateDrillupFrom(){const e=this.chart;e&&e.mapView&&(e.mapView.allowTransformAnimation=!1),this.options&&(this.options.inactiveOtherPoints=!0)},animateDrillupTo(e){const i=this.chart,o=this.group;i&&o&&(e?(o.attr({opacity:.01}),this.options&&(this.options.inactiveOtherPoints=!0)):(o.animate({opacity:1},i.options.drilldown.animation),i.drilldown&&i.drilldown.fadeInGroup(this.dataLabelsGroup)))}}),Point.prototype.doDrilldown=function(){this.runDrilldown()},Point.prototype.runDrilldown=function(t,e,i){const o=this.series,r=o.chart,n=r.options.drilldown;let s=(n.series||[]).length,l;for(r.ddDupes||(r.ddDupes=[]);s--&&!l;)n.series[s].id===this.drilldown&&-1===r.ddDupes.indexOf(this.drilldown)&&(l=n.series[s],r.ddDupes.push(this.drilldown));fireEvent(r,"drilldown",{point:this,seriesOptions:l,category:e,originalEvent:i,points:void 0!==e&&this.series.xAxis.getDDPoints(e).slice(0)},function(e){const i=e.point.series&&e.point.series.chart,o=e.seriesOptions;i&&o&&(t?i.addSingleSeriesAsDrilldown(e.point,o):i.addSeriesAsDrilldown(e.point,o))})},Axis.prototype.drilldownCategory=function(i,o){this.getDDPoints(i).forEach(function(e){e&&e.series&&e.series.visible&&e.runDrilldown&&e.runDrilldown(!0,i,o)}),this.chart.applyDrilldown()},Axis.prototype.getDDPoints=function(e){return this.ddPoints&&this.ddPoints[e]||[]},Tick.prototype.drillable=function(){const i=this.pos,e=this.label,o=this.axis,t="xAxis"===o.coll&&o.getDDPoints,r=t&&o.getDDPoints(i),n=o.chart.styledMode;t&&(e&&r&&r.length?(e.drillable=!0,e.basicStyles||n||(e.basicStyles=merge(e.styles)),e.addClass("highcharts-drilldown-axis-label"),e.removeOnDrillableClick&&removeEvent(e.element,"click"),e.removeOnDrillableClick=addEvent(e.element,"click",function(e){e.preventDefault(),o.drilldownCategory(i,e)}),n||e.css(o.chart.options.drilldown.activeAxisLabelStyle)):e&&e.drillable&&e.removeOnDrillableClick&&(n||(e.styles={},e.element.removeAttribute("style"),e.css(e.basicStyles)),e.removeOnDrillableClick(),e.removeClass("highcharts-drilldown-axis-label")))},addEvent(Point,"afterInit",function(){var e=this;return e.drilldown&&!e.unbindDrilldownClick&&(e.unbindDrilldownClick=addEvent(e,"click",handlePointClick)),e}),addEvent(Point,"update",function(e){var i=this,e=e.options||{};e.drilldown&&!i.unbindDrilldownClick?i.unbindDrilldownClick=addEvent(i,"click",handlePointClick):!e.drilldown&&void 0!==e.drilldown&&i.unbindDrilldownClick&&(i.unbindDrilldownClick=i.unbindDrilldownClick())});const handlePointClick=function(e){const i=this.series;i.xAxis&&!1===i.chart.options.drilldown.allowPointDrilldown?i.xAxis.drilldownCategory(this.x,e):this.runDrilldown(void 0,void 0,e)},applyCursorCSS=(addEvent(Series,"afterDrawDataLabels",function(){const t=this.chart.options.drilldown.activeDataLabelStyle,r=this.chart.renderer,n=this.chart.styledMode;this.points.forEach(function(e){const i=e.options.dataLabels,o=pick(e.dlOptions,i&&i.style,{});e.drilldown&&e.dataLabel&&("contrast"!==t.color||n||(o.color=r.getContrast(e.color||this.color)),i&&i.color&&(o.color=i.color),e.dataLabel.addClass("highcharts-drilldown-data-label"),n||e.dataLabel.css(t).css(o))},this)}),function(e,i,o,t){e[o?"addClass":"removeClass"]("highcharts-drilldown-point"),t||e.css({cursor:i})});addEvent(Series,"afterDrawTracker",function(){const i=this.chart.styledMode;this.points.forEach(function(e){e.drilldown&&e.graphic&&applyCursorCSS(e.graphic,"pointer",!0,i)})}),addEvent(Point,"afterSetState",function(){var e=this.series.chart.styledMode;this.drilldown&&this.series.halo&&"hover"===this.state?applyCursorCSS(this.series.halo,"pointer",!0,e):this.series.halo&&applyCursorCSS(this.series.halo,"auto",!1,e)}),addEvent(Chart,"drillup",function(){this.resetZoomButton&&(this.resetZoomButton=this.resetZoomButton.destroy())}),addEvent(Chart,"drillupall",function(){this.resetZoomButton&&this.showResetZoom()});