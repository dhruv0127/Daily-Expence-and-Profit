"use strict";import Chart from"../Core/Chart/Chart.js";import F from"../Core/FormatUtilities.js";const format=F["format"];import H from"../Core/Globals.js";const win=H["win"];import U from"../Core/Utilities.js";const{error,extend,merge,wrap}=U;function topo2geo(t,o){o=o||Object.keys(t.objects)[0];const e=t.objects[o];if(e["hc-decoded-geojson"])return e["hc-decoded-geojson"];let n=t.arcs;if(t.transform){const{scale:i,translate:s}=t.transform;n=t.arcs.map(t=>{let o=0,e=0;return t.map(t=>((t=t.slice())[0]=(o+=t[0])*i[0]+s[0],t[1]=(e+=t[1])*i[1]+s[1],t))})}const r=t=>"number"==typeof t[0]?t.reduce((t,o,e)=>{let r=o<0?n[~o]:n[o];return o<0?(r=r.slice(0,0===e?r.length:r.length-1)).reverse():e&&(r=r.slice(1)),t.concat(r)},[]):t.map(r);o=e.geometries.map(t=>({type:"Feature",properties:t.properties,geometry:{type:t.type,coordinates:t.coordinates||r(t.arcs)}})),o={type:"FeatureCollection",copyright:t.copyright,copyrightShort:t.copyrightShort,copyrightUrl:t.copyrightUrl,features:o,"hc-recommended-mapview":e["hc-recommended-mapview"],bbox:t.bbox,title:t.title};return e["hc-decoded-geojson"]=o}function geojson(t,i="map",o){const s=[],e="Topology"===t.type?topo2geo(t):t;return e.features.forEach(function(t){var o,e=t.geometry||{},r=e.type,e=e.coordinates,t=t.properties;let n;("map"!==i&&"mapbubble"!==i||"Polygon"!==r&&"MultiPolygon"!==r)&&("mapline"!==i||"LineString"!==r&&"MultiLineString"!==r)?"mappoint"===i&&"Point"===r&&e.length&&(n={geometry:{coordinates:e,type:r}}):e.length&&(n={geometry:{coordinates:e,type:r}}),n&&(e=t&&(t.name||t.NAME),r=t&&t.lon,o=t&&t.lat,s.push(extend(n,{lat:"number"==typeof o?o:void 0,lon:"number"==typeof r?r:void 0,name:"string"==typeof e?e:void 0,properties:t})))}),o&&e.copyrightShort&&(o.chart.mapCredits=format(o.chart.options.credits.mapText,{geojson:e}),o.chart.mapCreditsFull=format(o.chart.options.credits.mapTextFull,{geojson:e})),s}Chart.prototype.transformFromLatLon=function(t,o){const e=this.options.chart.proj4||win.proj4;var r,n,i,s,a,p,c,l,m,h;{if(e)return{jsonmarginX:r=0,jsonmarginY:n=0,jsonres:i=1,scale:s=1,xoffset:a=0,xpan:p=0,yoffset:c=0,ypan:l=0}=o,t=e(o.crs,[t.lon,t.lat]),m=o.cosAngle||o.rotation&&Math.cos(o.rotation),h=o.sinAngle||o.rotation&&Math.sin(o.rotation),{x:(((o=o.rotation?[t[0]*m+t[1]*h,-t[0]*h+t[1]*m]:t)[0]-a)*s+p)*i+r,y:-(((c-o[1])*s+l)*i-n)};error(21,!1,this)}},Chart.prototype.transformToLatLon=function(t,o){const e=this.options.chart.proj4||win.proj4;var r,n,i,s,a,p,c,l;if(e){if(null!==t.y)return{jsonmarginX:p=0,jsonmarginY:r=0,jsonres:n=1,scale:i=1,xoffset:l=0,xpan:c=0,yoffset:s=0,ypan:a=0}=o,p={x:((t.x-p)/n-c)/i+l,y:((t.y-r)/n+a)/i+s},c=o.cosAngle||o.rotation&&Math.cos(o.rotation),l=o.sinAngle||o.rotation&&Math.sin(o.rotation),{lat:(t=e(o.crs,"WGS84",o.rotation?{x:p.x*c+p.y*-l,y:p.x*l+p.y*c}:p)).y,lon:t.x}}else error(21,!1,this)},Chart.prototype.fromPointToLatLon=function(t){return this.mapView&&this.mapView.projectedUnitsToLonLat(t)},Chart.prototype.fromLatLonToPoint=function(t){return this.mapView&&this.mapView.lonLatToProjectedUnits(t)},wrap(Chart.prototype,"addCredits",function(t,o){o=merge(!0,this.options.credits,o),this.mapCredits&&(o.href=null),t.call(this,o),this.credits&&this.mapCreditsFull&&this.credits.attr({title:this.mapCreditsFull})});const GeoJSONModule={geojson:H.geojson=geojson,topo2geo:H.topo2geo=topo2geo};export default GeoJSONModule;