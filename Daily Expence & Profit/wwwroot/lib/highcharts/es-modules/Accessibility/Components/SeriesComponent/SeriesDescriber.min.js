"use strict";import AnnotationsA11y from"../AnnotationsA11y.js";const getPointAnnotationTexts=AnnotationsA11y["getPointAnnotationTexts"];import ChartUtilities from"../../Utils/ChartUtilities.js";const{getAxisDescription,getSeriesFirstPointElement,getSeriesA11yElement,unhideChartElementFromAT}=ChartUtilities;import F from"../../../Core/FormatUtilities.js";const{format,numberFormat}=F;import HTMLUtilities from"../../Utils/HTMLUtilities.js";const{reverseChildNodes,stripHTMLTagsFromString:stripHTMLTags}=HTMLUtilities;import U from"../../../Core/Utilities.js";const{find,isNumber,pick,defined}=U;function findFirstPointWithGraphic(i){const t=i.index;return i.series&&i.series.data&&defined(t)&&find(i.series.data,function(i){return!!(i&&void 0!==i.index&&i.index>t&&i.graphic&&i.graphic.element)})||null}function shouldAddMockPoint(i){const t=i.series,e=t&&t.chart,s=t&&t.is("sunburst"),o=i.isNull,r=e&&e.options.accessibility.point.describeNull;return o&&!s&&r}function makeMockElement(i,t){const e=i.series.chart.renderer,s=e.rect(t.x,t.y,1,1);return s.attr({class:"highcharts-a11y-mock-point",fill:"none",opacity:0,"fill-opacity":0,"stroke-opacity":0}),s}function addMockPointElement(i){const t=i.series,e=findFirstPointWithGraphic(i),s=e&&e.graphic,o=s?s.parentGroup:t.graph||t.group,r=e?{x:pick(i.plotX,e.plotX,0),y:pick(i.plotY,e.plotY,0)}:{x:pick(i.plotX,0),y:pick(i.plotY,0)},n=makeMockElement(i,r);if(o&&o.element)return i.graphic=n,i.hasMockGraphic=!0,n.add(o),o.element.insertBefore(n.element,s?s.element:null),n.element}function hasMorePointsThanDescriptionThreshold(i){var t=i.chart.options.accessibility.series.pointDescriptionEnabledThreshold;return!!(!1!==t&&i.points&&i.points.length>=t)}function shouldSetScreenReaderPropsOnPoints(i){var t=i.options.accessibility||{};return!hasMorePointsThanDescriptionThreshold(i)&&!t.exposeAsGroupOnly}function shouldSetKeyboardNavPropsOnPoints(i){var t=i.chart.options.accessibility.keyboardNavigation.seriesNavigation;return!(!i.points||!(i.points.length<t.pointNavigationEnabledThreshold||!1===t.pointNavigationEnabledThreshold))}function shouldDescribeSeriesElement(i){var t=i.chart,e=t.options.chart,e=e.options3d&&e.options3d.enabled,s=1<t.series.length,t=t.options.accessibility.series.describeSingleSeries,o=(i.options.accessibility||{}).exposeAsGroupOnly;return!(e&&s)&&(s||t||o||hasMorePointsThanDescriptionThreshold(i))}function pointNumberToString(i,t){var i=i.series,e=i.chart,s=e.options.accessibility.point||{},o=i.options.accessibility&&i.options.accessibility.point||{},i=i.tooltipOptions||{},e=e.options.lang;return isNumber(t)?numberFormat(t,o.valueDecimals||s.valueDecimals||i.valueDecimals||-1,e.decimalPoint,e.accessibility.thousandsSep||e.thousandsSep):t}function getSeriesDescriptionText(i){var t=(i.options.accessibility||{}).description;return t&&i.chart.langFormat("accessibility.series.description",{description:t,series:i})||""}function getSeriesAxisDescriptionText(i,t){var e=i[t];return i.chart.langFormat("accessibility.series."+t+"Description",{name:getAxisDescription(e),series:i})}function getPointA11yTimeDescription(i){const t=i.series,e=t.chart,s=t.options.accessibility&&t.options.accessibility.point||{},o=e.options.accessibility.point||{},r=t.xAxis&&t.xAxis.dateTime;var n;if(r)return n=r.getXDateFormat(i.x||0,e.options.tooltip.dateTimeLabelFormats),n=s.dateFormatter&&s.dateFormatter(i)||o.dateFormatter&&o.dateFormatter(i)||s.dateFormat||o.dateFormat||n,e.time.dateFormat(n,i.x||0,void 0)}function getPointXDescription(i){var t=getPointA11yTimeDescription(i),e=(i.series.xAxis||{}).categories&&defined(i.category)&&(""+i.category).replace("<br/>"," "),s=defined(i.id)&&(""+i.id).indexOf("highcharts-")<0,o="x, "+i.x;return i.name||t||e||(s?i.id:o)}function getPointArrayMapValueDescription(s,i,t){const o=i||"",r=t||"",e=s.series.pointArrayMap;return e.reduce(function(i,t){t=t;var e,t=void 0!==(e=pointNumberToString(s,pick(s[t],s.options[t])))?t+": "+o+e+r:e;return t?i+(i.length?", ":"")+t:i},"")}function getPointValue(i){const t=i.series,e=t.chart.options.accessibility.point||{},s=t.chart.options.accessibility&&t.chart.options.accessibility.point||{},o=t.tooltipOptions||{},r=s.valuePrefix||e.valuePrefix||o.valuePrefix||"",n=s.valueSuffix||e.valueSuffix||o.valueSuffix||"",a=void 0!==i.value?"value":"y",c=pointNumberToString(i,i[a]);return i.isNull?t.chart.langFormat("accessibility.series.nullPointValue",{point:i}):t.pointArrayMap?getPointArrayMapValueDescription(i,r,n):r+c+n}function getPointAnnotationDescription(i){const t=i.series.chart;var e=getPointAnnotationTexts(i);return e.length?t.langFormat("accessibility.series.pointAnnotationsDescription",{point:i,annotations:e}):""}function getPointValueDescription(i){var t=i.series,e=t.chart,s=t.options.accessibility,s=s&&s.point&&s.point.valueDescriptionFormat||e.options.accessibility.point.valueDescriptionFormat,t=pick(t.xAxis&&t.xAxis.options.accessibility&&t.xAxis.options.accessibility.enabled,!e.angular&&"flowmap"!==t.type),o=t?getPointXDescription(i):"",o={point:i,index:defined(i.index)?i.index+1:"",xDescription:o,value:getPointValue(i),separator:t?", ":""};return format(s,o,e)}function defaultPointDescriptionFormatter(i){var t=i.series,e=1<t.chart.series.length||t.options.name,s=getPointValueDescription(i),o=i.options&&i.options.accessibility&&i.options.accessibility.description,o=o?" "+o:"",e=e?" "+t.name+".":"",t=getPointAnnotationDescription(i),t=t?" "+t:"";return i.accessibility=i.accessibility||{},(i.accessibility.valueDescription=s)+o+e+t}function setPointScreenReaderAttribs(i,t){const e=i.series,s=e.chart.options.accessibility.point||{},o=e.options.accessibility&&e.options.accessibility.point||{},r=stripHTMLTags(o.descriptionFormatter&&o.descriptionFormatter(i)||s.descriptionFormatter&&s.descriptionFormatter(i)||defaultPointDescriptionFormatter(i));t.setAttribute("role","img"),t.setAttribute("aria-label",r)}function describePointsInSeries(s){const o=shouldSetScreenReaderPropsOnPoints(s),i=shouldSetKeyboardNavPropsOnPoints(s),r=s.chart.options.accessibility.point.describeNull;(o||i)&&s.points.forEach(i=>{const t=i.graphic&&i.graphic.element||shouldAddMockPoint(i)&&addMockPointElement(i),e=i.options&&i.options.accessibility&&!1===i.options.accessibility.enabled;t&&(i.isNull&&!r?t.setAttribute("aria-hidden",!0):(t.setAttribute("tabindex","-1"),s.chart.styledMode||(t.style.outline="none"),o&&!e?setPointScreenReaderAttribs(i,t):t.setAttribute("aria-hidden",!0)))})}function defaultSeriesDescriptionFormatter(t){function i(i){return e[i]&&1<e[i].length&&t[i]}const e=t.chart,s=e.types||[],o=getSeriesDescriptionText(t),r=t.index+1,n=getSeriesAxisDescriptionText(t,"xAxis"),a=getSeriesAxisDescriptionText(t,"yAxis"),c={seriesNumber:r,series:t,chart:e},l=1<s.length?"Combination":"",p=e.langFormat("accessibility.series.summary."+t.type+l,c)||e.langFormat("accessibility.series.summary.default"+l,c),u=(i("yAxis")?" "+a+".":"")+(i("xAxis")?" "+n+".":""),d=pick(t.options.accessibility&&t.options.accessibility.descriptionFormat,e.options.accessibility.series.descriptionFormat,"");return format(d,{seriesDescription:p,authorDescription:o?" "+o:"",axisDescription:u,series:t,chart:e,seriesNumber:r},void 0)}function describeSeriesElement(i,t){const e=i.options.accessibility||{},s=i.chart.options.accessibility,o=s.landmarkVerbosity;e.exposeAsGroupOnly?t.setAttribute("role","img"):"all"===o?t.setAttribute("role","region"):t.setAttribute("role","group"),t.setAttribute("tabindex","-1"),i.chart.styledMode||(t.style.outline="none"),t.setAttribute("aria-label",stripHTMLTags(s.series.descriptionFormatter&&s.series.descriptionFormatter(i)||defaultSeriesDescriptionFormatter(i)))}function describeSeries(i){const t=i.chart,e=getSeriesFirstPointElement(i),s=getSeriesA11yElement(i),o=t.is3d&&t.is3d();s&&(s.lastChild!==e||o||reverseChildNodes(s),describePointsInSeries(i),unhideChartElementFromAT(t,s),shouldDescribeSeriesElement(i)?describeSeriesElement(i,s):s.removeAttribute("aria-label"))}const SeriesDescriber={defaultPointDescriptionFormatter:defaultPointDescriptionFormatter,defaultSeriesDescriptionFormatter:defaultSeriesDescriptionFormatter,describeSeries:describeSeries};export default SeriesDescriber;